# Excel uygulamasını başlat
$excelApp = New-Object -ComObject Excel.Application
$excelApp.Visible = $false

# Klasör ve çıktı yolu tanımlamaları
$folderPath = "F:\Serhat\RvTools_Inventory\Reports"
$timestamp = Get-Date -Format "ddMMyyyy-HHmmss"
$csvFilePath = "\\pgarwebwin01\WinWin\Windows VM Networks\vNetworks-$timestamp.csv"

# vCenter sunucular listesi
$vcenters = @("ptekvcs01", "apgartstvcs201", "apgaraavcs801", "apgarvcsdt01")

# Tüm verilerin toplanacağı dizi
$allData = @()

# En güncel Excel dosyasını döndüren fonksiyon
function Get-LatestExcelFile {
    param (
        [string]$Keyword,
        [string]$FolderPath
    )

    $allFiles = Get-ChildItem -Path $FolderPath -Filter "*.xlsx"
    $filteredFiles = $allFiles | Where-Object { $_.Name -like "*$Keyword*" }
    return $filteredFiles | Sort-Object LastWriteTime -Descending | Select-Object -First 1
}

# Belirtilen Excel dosyasından verileri çıkaran fonksiyon
function Process-ExcelFile {
    param (
        [System.IO.FileInfo]$ExcelFile,
        [string]$vCenter,
        [System.__ComObject]$ExcelApp
    )

    $workbook = $ExcelApp.Workbooks.Open("$folderPath\$($ExcelFile.Name)")
    $worksheet = $workbook.Sheets.Item(6)
    $rows = $worksheet.UsedRange.Rows

    $fileData = @()

    foreach ($row in $rows) {
        if ($row.Cells.Item(22).Text -notmatch "windows server") {
            continue
        }

        $fileData += [PSCustomObject]@{
            "Sunucu Adı"     = $row.Cells.Item(1).Text
            "Subnet Bilgisi" = $row.Cells.Item(7).Text.Split('_')[-1] -replace '%2f','/'
            "Mac Adresi"     = $row.Cells.Item(11).Text
            "IP Adresi"      = $row.Cells.Item(13).Text -replace ',', ' -'
            "İşletim Sistemi"= $row.Cells.Item(22).Text
            "Created Date"   = ""
            "vCenter"        = $vCenter
        }
    }

    $workbook.Close($false)
    return $fileData
}

# Created Date bilgilerini eşleyen fonksiyon
function Update-CreatedDateInData {
    param (
        [array]$DataToUpdate,
        [System.IO.FileInfo]$ExcelFile,
        [System.__ComObject]$ExcelApp
    )

    $workbook = $ExcelApp.Workbooks.Open("$folderPath\$($ExcelFile.Name)")
    $worksheet = $workbook.Sheets.Item(1)

    $usedRange = $worksheet.UsedRange
    $rowCount = $usedRange.Rows.Count

    $serverNameColumn = 1   # A sütunu
    $createdDateColumn = 10 # J sütunu

    # Excel içeriğini bir hash tablosuna al
    $excelDataMap = @{}
    for ($row = 1; $row -le $rowCount; $row++) {
        $serverName = $worksheet.Cells.Item($row, $serverNameColumn).Text
        $createdDate = $worksheet.Cells.Item($row, $createdDateColumn).Value2

        if (![string]::IsNullOrWhiteSpace($serverName)) {
            $excelDataMap[$serverName] = $createdDate
        }
    }

    # Her satırı güncelle
    foreach ($item in $DataToUpdate) {
        $serverName = $item."Sunucu Adı"
        if ($excelDataMap.ContainsKey($serverName)) {
            $item."Created Date" = $excelDataMap[$serverName]
        } else {
            Write-Warning "Excel'de '$serverName' sunucusu bulunamadı."
        }
    }

    $workbook.Close($false)
}

# Ana döngü
foreach ($vcenter in $vcenters) {
    $latestFile = Get-LatestExcelFile -Keyword $vcenter -FolderPath $folderPath

    if ($latestFile) {
        Write-Output "Dosya bulundu: $($latestFile.Name)"

        try {
            $fileData = Process-ExcelFile -ExcelFile $latestFile -vCenter $vcenter -ExcelApp $excelApp
            Update-CreatedDateInData -DataToUpdate $fileData -ExcelFile $latestFile -ExcelApp $excelApp

            $allData += $fileData
        } catch {
            Write-Warning "Hata oluştu '$($latestFile.Name)' dosyasında: $_"
        }
    } else {
        Write-Warning "Dosya bulunamadı: $vcenter"
    }
}

# CSV olarak dışa aktar
$allData | Select-Object "Sunucu Adı","IP Adresi","Subnet Bilgisi","Mac Adresi","İşletim Sistemi","Created Date","vCenter" | 
Export-Csv -Path $csvFilePath -NoTypeInformation -Encoding UTF8

# Excel uygulamasını kapat ve COM nesnesini temizle
$excelApp.Quit()
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelApp) | Out-Null
[GC]::Collect()
[GC]::WaitForPendingFinalizers()

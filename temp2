## Ignore SSL Certificates
add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy



$names=@("GBELKT05","GBELKT20","GBJBOT03")

$token=(F:\Ali\powershell\vrops\Get_vROPS_Token.ps1 -tokenType "pendik")
if($token -eq $null){
    return "token is null"
}
$headers = @{
    "Content-Type" = "application/json"
    "Authorization" = "vRealizeOpsToken $token"
}

$resources = @()
foreach($name in $names){
    $reportsUrl = "https://ptekvrops01.fw.garanti.com.tr/suite-api/api/adapterkinds/VMWARE/resourcekinds/virtualmachine/resources?identifiers[VMEntityName]=$($name)"

    $reportsResponse = Invoke-RestMethod -Method Get -Uri $reportsUrl -Headers $headers -ContentType "application/json"
    $resources+="$name, $($reportsResponse.resources.resource.identifier)"

}

$endDate = Get-Date
$beginDate = $endDate.AddMonths(-1)

$epoch = Get-Date "1970-01-01 00:00:00Z"

$beginTimestamp = [math]::Round(($beginDate.ToUniversalTime() - $epoch).TotalMilliseconds)
$endTimestamp = [math]::Round(($endDate.ToUniversalTime() - $epoch).TotalMilliseconds)


$metrikKategorileri = @{
    "cpu" = @(
        "cpu|usage_average",
        "cpu|demandPct",
        "cpu|readyPct",
        "cpu|usagemhz_average",
        "guest|cpu_queue"

    )
    "memory" = @(
        "mem|swapoutRate_average",
        "mem|swapinRate_average",
        "mem|usage_average",
        "mem|balloonPct"
    )
    "disk" = @(
        "virtualDisk|read_average",
        "virtualDisk|write_average",
        "virtualDisk:Aggregate of all instances|totalLatency"
    )
    "network" = @(
        "net|transmitted_average",
        "net|received_average",
        "net:Aggregate of all instances|droppedPct"
    )
}


$allResourcesData = @{}

foreach ($resource in $resources) {
    $resourceId=($resource -split ',')[1].Trim()
    $reportsUrl = "https://ptekvrops01.fw.garanti.com.tr/suite-api/api/resources/$resourceId/stats?&intervalType=MINUTES&intervalQuantifier=20&rollUpType=AVG&begin=$beginTimestamp&end=$endTimestamp"
    $reportsResponse = Invoke-RestMethod -Method Get -Uri $reportsUrl -Headers $headers -ContentType "application/json"
    
    # Her kategori için ayrı veri yapısı
    $kategorilereAyrilmisMetrikler = @{}
    # Kategorileri başlat
    foreach ($kategori in $metrikKategorileri.Keys) {
        $kategorilereAyrilmisMetrikler[$kategori] = @()
    }
    
    # Tüm statları kontrol et ve kategorilere ayır
    foreach ($stat in $reportsResponse.'stats-of-resources'.'stats-of-resource'.'stat-list'.stat) {
        foreach ($kategoriAdi in $metrikKategorileri.Keys) {
            if ($metrikKategorileri[$kategoriAdi] -contains $stat.statKey.key) {
                $kategorilereAyrilmisMetrikler[$kategoriAdi] += [PSCustomObject]@{
                    StatKey = $stat.statKey.key
                    Value = $stat.data
                }
                break
            }
        }
    }
    
    # Bu resource'un verilerini ana yapıya ekle
    $allResourcesData[($resource -split ',')[0].Trim()] = $kategorilereAyrilmisMetrikler
}

$jsonOutput = $allResourcesData | ConvertTo-Json -Depth 10
$outputFilePath = "F:\Ali\VMsMetrics.json"
Set-Content -Path $outputFilePath -Value $jsonOutput -Encoding UTF8
Write-Host "Metrics saved to $outputFilePath"

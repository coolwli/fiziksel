# Define vCenter Servers and Credentials
$vcenters = @("ptekvcs01", "apgaraavcs801", "apgartstvcs201", "ptekvcsd01", "apgartksvcs201", "apgartksvcs801")

# Read and decrypt service job credentials
$encrypted = Get-Content F:\Serhat\servicejobs_password.txt | ConvertTo-SecureString
$servicejobscred = New-Object System.Management.Automation.PsCredential("GARANTI\servicejobs", $encrypted)

# Establish SQL connection
$conn = New-Object System.Data.SqlClient.SqlConnection("Data Source=TEKSCR1\SQLEXPRESS;Database=CloudUnited;Integrated Security=True")
$conn.Open()

# Function to gather and insert host data
function Insert-HostData {
    param (
        [string]$vcenter,
        [array]$hostDataList
    )
    
    if ($hostDataList.Count -gt 0) {
        $values = $hostDataList -join ","
        $sql = @"
            INSERT INTO vmpediaHosts (
                HostName, HostModel, vCenter, HostManufacturer, HostCluster, HostDataCenter, LastUpdate, 
                HostTotalMemory, HostMemoryUsage, HostTotalCPU, HostCPUUsage, esxiVersion, HostHall,
                NumCpuThreads, CPUModel, DSName, DSCapacity, DSFree, DSPercentUsing, 
                HostStorageCapacity, HostFreeStorage, UptimeDay) 
            VALUES $values
"@
        
        try {
            $command = $conn.CreateCommand()
            $command.CommandText = $sql
            $command.ExecuteNonQuery()  # Execute the SQL insert statement
        } catch {
            Write-Error "Failed to insert data for $vcenter: $_"
        }
    }
}

# Iterate over each vCenter server
foreach ($vcenter in $vcenters) {
    try {
        Connect-VIServer -Server $vcenter -Credential $servicejobscred
        $hostDataList = @()

        $VMHosts = Get-VMHost
        foreach ($VMHost in $VMHosts) {
            # Extract host information
            $hostName = $VMHost.Name
            $hostCluster = $VMHost.Parent.Name -replace '#', ''
            $hostDataCenter = $VMHost.Parent.ParentFolder.Parent.Name
            $hostModel = $VMHost.Model
            $hostManufacturer = $VMHost.Manufacturer
            $lastWriteTime = Get-Date -Format "yyyy-MM-dd"

            $hostTotalMemory = [decimal]$VMHost.MemoryTotalGB
            $hostMemoryUsage = [decimal]$VMHost.MemoryUsageGB
            $hostTotalCpu = [decimal]($VMHost.CpuTotalMhz / 1000)
            $hostCpuUsage = [decimal]($VMHost.CpuUsageMhz / 1000)
            $hostNumNics = $VMHost.ExtensionData.Summary.Hardware.NumNics
            $version = $VMHost.Version

            $NumCpuThreads = $VMHost.ExtensionData.summary.hardware.NumCpuThreads
            $cpuModel = $VMHost.ExtensionData.summary.hardware.CpuModel
            $hall = $VMHost.CustomFields["hall"]

            # Gather datastore information
            $datastores = $VMHost | Get-Datastore
            $dsData = $datastores | ForEach-Object {
                [PSCustomObject]@{
                    Name        = $_.Name
                    CapacityGB  = $_.CapacityGB
                    FreeSpaceGB = $_.FreeSpaceGB
                    PercentUsed = [math]::Round(($_.CapacityGB - $_.FreeSpaceGB) / $_.CapacityGB * 100, 2)
                }
            }

            # Join datastore properties into strings
            $dsNames = ($dsData | Select-Object -ExpandProperty Name) -join '~'
            $dsCapacity = ($dsData | ForEach-Object { "{0:F2}" -f $_.CapacityGB }) -join '~'
            $dsFree = ($dsData | ForEach-Object { "{0:F2}" -f $_.FreeSpaceGB }) -join '~'
            $dsPercentUsing = ($dsData | ForEach-Object { $_.PercentUsed }) -join '~'
            $storageCapacity = ($dsData | Measure-Object -Property CapacityGB -Sum).Sum
            $freeStorage = ($dsData | Measure-Object -Property FreeSpaceGB -Sum).Sum

            $uptimeDays = ((Get-Date) - $VMHost.ExtensionData.Runtime.BootTime).Days

            # Add collected data to host data list
            $hostDataList += @"
            ('$hostName', '$hostModel', '$vcenter', '$hostManufacturer', '$hostCluster', '$hostDataCenter', '$lastWriteTime',
             $hostTotalMemory, $hostMemoryUsage, $hostTotalCpu, $hostCpuUsage, '$version', '$hall',
             $NumCpuThreads, '$cpuModel', '$dsNames', '$dsCapacity', '$dsFree', '$dsPercentUsing',
             $("{0:F2}" -f [decimal]$storageCapacity), $("{0:F2}" -f [decimal]$freeStorage),$uptimeDays)
"@
        }

        # Insert data into SQL
        Insert-HostData -vcenter $vcenter -hostDataList $hostDataList

    } catch {
        Write-Error "Failed to process vCenter $vcenter: $_"
    } finally {
        Disconnect-VIServer -Server $vcenter -Confirm:$false
    }
}

# Close the database connection
$conn.Close()

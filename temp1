# 1 yıllık zaman aralığını belirleyin
$startTime = (Get-Date).AddYears(-1)
$endTime = Get-Date

# Küme adını belirtin
$clusterName = "YourClusterName"

# Küme içindeki sanal makineleri alın
$vms = Get-Cluster -Name $clusterName | Get-VM

# Kümenin toplam CPU ve bellek bilgilerini alın
$cluster = Get-Cluster -Name $clusterName
$totalCpuMhz = $cluster.ExtensionData.Summary.TotalCpu
$totalMemoryMb = $cluster.ExtensionData.Summary.TotalMemory / 1MB
$freeCpuMhz = $totalCpuMhz - ($cluster | Get-VM | Get-Stat -Stat cpu.usage.average -Start $startTime -Finish $endTime | Measure-Object -Property Value -Sum | Select-Object -ExpandProperty Sum)
$freeMemoryMb = $totalMemoryMb - ($cluster | Get-VM | Get-Stat -Stat mem.usage.average -Start $startTime -Finish $endTime | Measure-Object -Property Value -Sum | Select-Object -ExpandProperty Sum)

# Küme bilgilerini yazdırın
Write-Host "Cluster: $clusterName"
Write-Host "Total CPU (MHz):" $totalCpuMhz
Write-Host "Free CPU (MHz):" $freeCpuMhz
Write-Host "Total Memory (MB):" $totalMemoryMb
Write-Host "Free Memory (MB):" $freeMemoryMb
Write-Host "--------------------------------------------"

# Her sanal makine için CPU, bellek, disk ve network kullanım verilerini alın ve yazdırın
foreach ($vm in $vms) {
    $vmName = $vm.Name

    # CPU ve bellek kullanım verilerini alın
    $cpuMetrics = Get-Stat -Entity $vm -Stat cpu.usage.average -Start $startTime -Finish $endTime
    $memMetrics = Get-Stat -Entity $vm -Stat mem.usage.average -Start $startTime -Finish $endTime

    # Disk kullanım verilerini alın (okuma ve yazma IOPS)
    $diskReadMetrics = Get-Stat -Entity $vm -Stat disk.numberReadAveraged.average -Start $startTime -Finish $endTime
    $diskWriteMetrics = Get-Stat -Entity $vm -Stat disk.numberWriteAveraged.average -Start $startTime -Finish $endTime

    # Network kullanım verilerini alın (giriş ve çıkış Mbps)
    $netInMetrics = Get-Stat -Entity $vm -Stat net.received.average -Start $startTime -Finish $endTime
    $netOutMetrics = Get-Stat -Entity $vm -Stat net.transmitted.average -Start $startTime -Finish $endTime

    # Ortalama ve maksimum CPU kullanımını hesaplayın
    $cpuAverage = $cpuMetrics | Measure-Object -Property Value -Average | Select-Object -ExpandProperty Average
    $cpuMax = $cpuMetrics | Measure-Object -Property Value -Maximum | Select-Object -ExpandProperty Maximum

    # Ortalama ve maksimum bellek kullanımını hesaplayın
    $memAverage = $memMetrics | Measure-Object -Property Value -Average | Select-Object -ExpandProperty Average
    $memMax = $memMetrics | Measure-Object -Property Value -Maximum | Select-Object -ExpandProperty Maximum

    # Ortalama ve maksimum disk okuma ve yazma kullanımını hesaplayın
    $diskReadAverage = $diskReadMetrics | Measure-Object -Property Value -Average | Select-Object -ExpandProperty Average
    $diskReadMax = $diskReadMetrics | Measure-Object -Property Value -Maximum | Select-Object -ExpandProperty Maximum
    $diskWriteAverage = $diskWriteMetrics | Measure-Object -Property Value -Average | Select-Object -ExpandProperty Average
    $diskWriteMax = $diskWriteMetrics | Measure-Object -Property Value -Maximum | Select-Object -ExpandProperty Maximum

    # Ortalama ve maksimum network giriş ve çıkış kullanımını hesaplayın
    $netInAverage = $netInMetrics | Measure-Object -Property Value -Average | Select-Object -ExpandProperty Average
    $netInMax = $netInMetrics | Measure-Object -Property Value -Maximum | Select-Object -ExpandProperty Maximum
    $netOutAverage = $netOutMetrics | Measure-Object -Property Value -Average | Select-Object -ExpandProperty Average
    $netOutMax = $netOutMetrics | Measure-Object -Property Value -Maximum | Select-Object -ExpandProperty Maximum

    # Sonuçları yazdırın
    Write-Host "VM Name: $vmName"
    Write-Host "CPU Average Usage (%):" $cpuAverage
    Write-Host "CPU Maximum Usage (%):" $cpuMax
    Write-Host "Memory Average Usage (%):" $memAverage
    Write-Host "Memory Maximum Usage (%):" $memMax
    Write-Host "Disk Read Average (IOPS):" $diskReadAverage
    Write-Host "Disk Read Maximum (IOPS):" $diskReadMax
    Write-Host "Disk Write Average (IOPS):" $diskWriteAverage
    Write-Host "Disk Write Maximum (IOPS):" $diskWriteMax
    Write-Host "Network In Average (Mbps):" $netInAverage
    Write-Host "Network In Maximum (Mbps):" $netInMax
    Write-Host "Network Out Average (Mbps):" $netOutAverage
    Write-Host "Network Out Maximum (Mbps):" $netOutMax
    Write-Host "--------------------------------------------"
}

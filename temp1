# Excel dosyasının yolu
$excelFile = "F:\Ali\deneme.xlsx"

$vcenter = "apgaraavcs801"

$excelObj = New-Object -ComObject Excel.Application
$excelObj.Visible = $false

try {
    $workbook = $excelObj.Workbooks.Open($excelFile)
    $worksheet = $workbook.Sheets.Item(1) 

 
    $usedRange = $worksheet.UsedRange
    $rows = $usedRange.Rows.Count
    $columns = $usedRange.Columns.Count

    try {
        Connect-VIServer -Server $vcenter -ErrorAction Stop
        for ($row = 2; $row -le $rows; $row++) {
            $esxName = $worksheet.Cells.Item($row, 1).Value2 
            $esxName
        
    }
        

    } catch {
        Write-Warning "vCenter $vcenter bağlantı hatası: $_"
    } finally {
        Disconnect-VIServer -Server $vcenter -Confirm:$false -ErrorAction SilentlyContinue
    }
    
    $workbook.Save()
} catch {
    Write-Error "Excel dosyası ile ilgili bir hata oluştu: $_"
} finally {
    # Çalışma kitabını kapatın ve Excel uygulamasını kapatın
    $workbook.Close() | Out-Null
    $excelObj.Quit()

    # COM nesnelerini serbest bırakın
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($worksheet) | Out-Null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelObj) | Out-Null
    [GC]::Collect()
    [GC]::WaitForPendingFinalizers()
}

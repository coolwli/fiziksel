using System;
using System.Threading.Tasks;
using System.Web;
using System.Net.Http;
using System.Text;
using System.Web.Script.Serialization;

public class TokenManager
{
    private static readonly string A_TokenCacheKey = "AToken";
    private static readonly string B_TokenCacheKey = "BToken";
    private static readonly TimeSpan TokenLifetime = TimeSpan.FromHours(3); // Token'ların geçerlilik süresi

    private static readonly HttpClient HttpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(60) };

    private static readonly string VropsServer = ConfigurationManager.AppSettings["VropsServer"];
    private static readonly string Username = ConfigurationManager.AppSettings["VropsUsername"];
    private static readonly string Password = ConfigurationManager.AppSettings["VropsPassword"];

    // Token A'yı almak için bu yöntemi kullanın
    public static async Task<string> GetATokenAsync()
    {
        var token = HttpRuntime.Cache[A_TokenCacheKey] as string;
        if (token == null || DateTime.Now >= (DateTime)HttpRuntime.Cache[A_TokenCacheKey + "_Expiry"])
        {
            try
            {
                token = await AcquireTokenAsync("A");
                HttpRuntime.Cache.Insert(
                    A_TokenCacheKey,
                    token,
                    null,
                    DateTime.Now.Add(TokenLifetime),
                    System.Web.Caching.Cache.NoSlidingExpiration);
                HttpRuntime.Cache.Insert(
                    A_TokenCacheKey + "_Expiry",
                    DateTime.Now.Add(TokenLifetime),
                    null,
                    DateTime.Now.Add(TokenLifetime),
                    System.Web.Caching.Cache.NoSlidingExpiration);
            }
            catch (Exception ex)
            {
                throw new Exception($"Token A alım hatası: {ex.Message}", ex);
            }
        }
        return token;
    }

    // Token B'yi almak için bu yöntemi kullanın
    public static async Task<string> GetBTokenAsync()
    {
        var token = HttpRuntime.Cache[B_TokenCacheKey] as string;
        if (token == null || DateTime.Now >= (DateTime)HttpRuntime.Cache[B_TokenCacheKey + "_Expiry"])
        {
            try
            {
                token = await AcquireTokenAsync("B");
                HttpRuntime.Cache.Insert(
                    B_TokenCacheKey,
                    token,
                    null,
                    DateTime.Now.Add(TokenLifetime),
                    System.Web.Caching.Cache.NoSlidingExpiration);
                HttpRuntime.Cache.Insert(
                    B_TokenCacheKey + "_Expiry",
                    DateTime.Now.Add(TokenLifetime),
                    null,
                    DateTime.Now.Add(TokenLifetime),
                    System.Web.Caching.Cache.NoSlidingExpiration);
            }
            catch (Exception ex)
            {
                throw new Exception($"Token B alım hatası: {ex.Message}", ex);
            }
        }
        return token;
    }

    // Token almak için genel yöntem
    private static async Task<string> AcquireTokenAsync(string tokenType)
    {
        var requestUri = $"{VropsServer}/suite-api/api/auth/token/acquire?_no_links=true";
        var requestBody = new { username = Username, password = Password, tokenType };
        var jsonContent = new JavaScriptSerializer().Serialize(requestBody);
        var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");

        try
        {
            var response = await HttpClient.PostAsync(requestUri, content);
            response.EnsureSuccessStatusCode();
            var responseContent = await response.Content.ReadAsStringAsync();
            return ExtractTokenFromResponse(responseContent, tokenType);
        }
        catch (Exception ex)
        {
            throw new Exception($"Token alınırken hata oluştu: {ex.Message}", ex);
        }
    }

    // Token'ı yanıt içeriğinden çıkarmak için bu yöntemi kullanın
    private static string ExtractTokenFromResponse(string responseData, string tokenType)
    {
        // Yanıt verisini ve token türünü kullanarak token'ı çıkarmak için gerekli işlemi burada yapın
        // Örnek olarak JSON veya XML analizine göre token'ı çıkartın
        // Bu örnekte basit bir JSON yanıtı varsayıyoruz
        dynamic responseJson = new JavaScriptSerializer().DeserializeObject(responseData);
        return responseJson[tokenType + "Token"];
    }
}

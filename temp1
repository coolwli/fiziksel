# Excel Uygulamasını başlat
$excelApp = New-Object -ComObject Excel.Application
$excelApp.Visible = $false

# Klasör yolu ve çıkış CSV dosyasının yolu
$folderPath = "C:\dosya_yolu\"
$csvFilePath = "C:\dosya_yolu\yeni_dosya.csv"

# Anahtar kelimeler dizisi - Buraya filtrelemek istediğiniz anahtar kelimeleri ekleyin
$keywords = @("kelime1", "kelime2", "kelime3")

# Toplanan verilerin saklanacağı bir dizi
$allData = @()

# Veriyi almak ve işlemek için her bir anahtar kelimeyi işleyelim
foreach ($keyword in $keywords) {
    $latestFile = GetLatestExcelFile($keyword, $folderPath)

    # Eğer geçerli bir dosya bulunmuşsa, veriyi işleyelim
    if ($latestFile) {
        try {
            $fileData = ProcessExcelFile($latestFile, $keyword, $excelApp)
            $allData += $fileData
        } catch {
            Write-Warning "Hata oluştu dosyada '$($latestFile.Name)': $_"
        }
    }
}

# Veriyi CSV'ye kaydet
Export-DataToCsv $allData $csvFilePath

# Excel uygulamasını kapat
$excelApp.Quit()

# Excel COM nesnelerini serbest bırak
Release-ComObjects $excelApp

# --- Fonksiyonlar Başlangıç ---

# En son eklenen dosyayı almak için kullanılan fonksiyon
function GetLatestExcelFile {
    param (
        [string]$keyword,
        [string]$folderPath
    )

    # Klasördeki tüm Excel dosyalarını al
    $allFiles = Get-ChildItem -Path $folderPath -Filter "*.xlsx"

    # Kelimeyi içeren dosyaları filtrele
    $filteredFiles = $allFiles | Where-Object { $_.Name -like "*$keyword*" }

    # Eğer filtrelenmiş dosya varsa, en son eklenen dosyayı al
    $latestFile = $filteredFiles | Sort-Object LastWriteTime -Descending | Select-Object -First 1

    return $latestFile
}

# Excel dosyasını işleyip veriyi almak için kullanılan fonksiyon
function ProcessExcelFile {
    param (
        [System.IO.FileInfo]$excelFile,
        [string]$keyword,
        [System.Object]$excelApp
    )

    # Dosyayı aç
    $workbook = $excelApp.Workbooks.Open($excelFile.FullName)

    # İkinci sayfayı al ve verileri oku
    $worksheet2 = $workbook.Sheets.Item(2)
    $usedRange2 = $worksheet2.UsedRange
    $rows2 = $usedRange2.Rows

    # Veriyi toplamak için bir dizi
    $fileData = @()

    foreach ($row in $rows2) {
        $rowData = @(
            $row.Cells.Item(3).Text,  # C sütunu
            $row.Cells.Item(4).Text,  # D sütunu
            $row.Cells.Item(5).Text,  # E sütunu
            $row.Cells.Item(6).Text   # F sütunu
        )

        $fileData += New-Object PSObject -property @{
            C = $rowData[0]
            D = $rowData[1]
            E = $rowData[2]
            F = $rowData[3]
            ExcelFileName = $excelFile.Name  # Excel dosyasının adı
            Keyword = $keyword  # İlgili anahtar kelime
        }
    }

    # Dördüncü sayfayı al ve C sütunundaki isme göre 9. sütun verisini al
    $worksheet4 = $workbook.Sheets.Item(4)
    $usedRange4 = $worksheet4.UsedRange
    $rows4 = $usedRange4.Rows

    # İkinci sayfadaki verileri üçüncü sayfadan alınan verilerle eşleştir
    $namesData = @{}
    foreach ($row in $rows4) {
        $key = $row.Cells.Item(3).Text  # C sütunu
        $value = $row.Cells.Item(9).Text # I sütunu (9. sütun)
        if ($key -and $value) {
            $namesData[$key] = $value
        }
    }

    # İkinci sayfadaki verileri üçüncü sayfadan alınan verilerle birleştir
    foreach ($item in $fileData) {
        $name = $item.C  # 2. sayfadaki C sütunu adı
        if ($namesData.ContainsKey($name)) {
            $item | Add-Member -MemberType NoteProperty -Name "ValueFromSheet4" -Value $namesData[$name]
        }
    }

    # Excel dosyasını kapat
    $workbook.Close($false)

    return $fileData
}

# Verileri CSV dosyasına aktarmak için kullanılan fonksiyon
function Export-DataToCsv {
    param (
        [Array]$data,
        [string]$csvFilePath
    )

    # Veriyi CSV'ye kaydet
    $data | Export-Csv -Path $csvFilePath -NoTypeInformation
}

# COM nesnelerini serbest bırakmak için kullanılan fonksiyon
function Release-ComObjects {
    param (
        [Object]$comObject
    )

    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($comObject) | Out-Null
}

# --- Fonksiyonlar Bitiş ---

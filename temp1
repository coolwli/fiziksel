$vcenters = @("ptekvcs01", "apgaraavcs801", "apgartstvcs201", "ptekvcsd01", "apgartksvcs201", "apgartksvcs801")
$vcenters = @("ptekvcs01")

$excelReport = @{}

foreach ($vcenter in $vcenters) {
    Connect-VIServer -Server $vcenter

    $report = @()

    $vcenterUsers = Get-VIPermission | Select-Object Principal, Role

    $vcenterUsers | ForEach-Object {
        if ($_.Principal -notmatch 'vsphere') {
            $report += [PSCustomObject]@{
                Domain    = $vcenter
                Principal  = $_.Principal
                Role       = $_.Role
                Inherited  = $false
            }
        }
    }

    $clusters = Get-Cluster

    foreach ($cluster in $clusters) {
        $clusterPermissions = Get-Cluster $cluster | Get-VIPermission
        foreach ($perm in $clusterPermissions) {
            $isInherited = ($perm.EntityId -ne $cluster.Id)

            if ($perm.Principal -icontains 'vsphere') {
                $report += [PSCustomObject]@{
                    Domain    = $cluster.Name
                    Principal  = $perm.Principal
                    Role       = $perm.Role
                    Inherited  = $isInherited
                }
            }
        }
    }

    $excelReport[$vcenter] = $report

    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

$excelReport.Values

$excelReport.GetEnumerator() | ForEach-Object {
    $vcenter = $_.Key
    $data = $_.Value

    $data | Export-Excel -Path "C:\path\to\your\report.xlsx" -WorksheetName $vcenter -Append
}

Write-Host "Raporlar başarıyla Excel dosyasına yazıldı."

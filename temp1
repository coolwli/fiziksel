# Excel dosyasının yolu
$excelFile = "F:\Ali\deneme.xlsx"
$vcenters=("ptekvcs01","apgaraavcs801","apgartstvcs201","ptekvcsd01","apgartksvcs201","apgartksvcs801")

$vcenter = "apgaraavcs801"

$excelObj = New-Object -ComObject Excel.Application
$excelObj.Visible = $false

try {
    $workbook = $excelObj.Workbooks.Open($excelFile)
    $worksheet = $workbook.Sheets.Item(1)

    $usedRange = $worksheet.UsedRange
    $rows = $usedRange.Rows.Count

    try {
        Connect-VIServer -Server $vcenter -ErrorAction Stop
        
        for ($row = 2; $row -le $rows; $row++) {
            $esxName = $worksheet.Cells.Item($row, 1).Value2
            $esxName="fsesxpc801.fw.garanti.com.tr"
            $esxHost = Get-VMHost -Name $esxName -ErrorAction SilentlyContinue
            
            # İşlemci türünü ve diğer bilgileri al
            $cpuType = $esxHost.ProcessorType
            $processorCount = [string]$esxHost.ExtensionData.summary.hardware.NumCpuThreads 
            $totalCores = [string]($esxHost.NumCpu*$esxHost.ExtensionData.Summary.Hardware.NumCpuPkgs)
            
            # Excel dosyasındaki ilgili hücreleri doldur
            $worksheet.Cells.Item($row, 2).Value2 = $cpuType
            $worksheet.Cells.Item($row, 3).Value2 = $processorCount
            $worksheet.Cells.Item($row, 4).Value2 = $totalCores
        }

    } catch {
        Write-Warning "$_"
    } finally {
        Disconnect-VIServer -Server $vcenter -Confirm:$false -ErrorAction SilentlyContinue
    }

    # Dosyayı kaydet
    $workbook.Save()

} catch {
    Write-Error "Excel dosyası ile ilgili bir hata oluştu: $_"
} finally {
    # Çalışma kitabını kapatın ve Excel uygulamasını kapatın
    $workbook.Close() | Out-Null
    $excelObj.Quit()

    # COM nesnelerini serbest bırakın
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($worksheet) | Out-Null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($workbook) | Out-Null
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excelObj) | Out-Null
    [GC]::Collect()
    [GC]::WaitForPendingFinalizers()
}

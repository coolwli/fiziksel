
$vcenters = @("ptekvcs01")
foreach ($vcenter in $vcenters) {
    Connect-VIServer -Server $vcenter
    $userPermissions = @{}
    $vcenterUsers = Get-VIPermission | Select-Object Principal, Role
    foreach ($user in $vcenterUsers) {
        if ($user.Principal -notmatch 'vsphere') {
            if (-not $userPermissions.ContainsKey($user.Principal)) {
                $userPermissions[$user.Principal] = @{}
            }
            $userPermissions[$user.Principal][$user.Role] = $vcenter
        }
    }
    $clusters = Get-Cluster
    foreach ($cluster in $clusters) {
        $clusterPermissions = Get-Cluster $cluster | Get-VIPermission
        foreach ($perm in $clusterPermissions) {
            if ($perm.Principal -notmatch 'vsphere') {
                if (-not $userPermissions.ContainsKey($perm.Principal)) {
                    $userPermissions[$perm.Principal] = @{}
                }
                if ($userPermissions[$perm.Principal][$perm.Role].ContainsKey()) {
                    $userPermissions[$perm.Principal][$perm.Role] += ", $($cluster.Name)"
                } else {
                    $userPermissions[$perm.Principal][$perm.Role] = $cluster.Name
                }
            }
        }
    }
    $userPermissions
    Disconnect-VIServer -Server $vcenter -Confirm:$false
}
Write-Host "Kullanıcı izin raporları başarıyla Excel dosyasına yazıldı."

param(
    [int]$start = 0
)

$reset = $start
$vcenters = ("ptekvcs01", "apgaraavcs801", "apgartstvcs201", "ptekvcsd01")
$vmInfoArray = @()
$conn = New-Object System.Data.SqlClient.SqlConnection "Data Source=TEKSCR1\SQLEXPRESS;Database=CloudUnited;Integrated Security=True"

$conn.Open()

foreach ($vcenter in $vcenters) {
    Connect-VIServer -Server $vcenter

    if (!$vms) {
        $vms = Get-VM
    }

    foreach ($vm in $vms) {
        # VM bilgilerini toplu olarak al
        $vmInfo = [PSCustomObject]@{
            VMName = $vm.Name
            VMOwner = $vm.CustomFields.Value[5]
            VMPowerState = $vm.PowerState
            VMGuestOS = $vm.Guest.OSFullName
            # Diğer VM bilgileri buraya eklenebilir
        }

        $vmInfoArray += $vmInfo
    }

    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

# Tüm VM bilgilerini tek bir sorguda eklemek için hazırla
$sqlValues = $vmInfoArray | ForEach-Object {
    "('{0}', '{1}', '{2}', '{3}')" -f $_.VMName, $_.VMOwner, $_.VMPowerState, $_.VMGuestOS
}

$sqlValuesString = $sqlValues -join ','

$sql = @"
INSERT INTO VMInfos2 (VMName, VMOwner, VMPowerState, VMGuestOS)
VALUES
$sqlValuesString
"@

$command = $conn.CreateCommand()
$command.CommandText = $sql
$row = $command.ExecuteNonQuery()

$conn.Close()

private const int MaxRetryAttempts = 3; // Maksimum deneme sayısı
private const int RetryDelayMilliseconds = 3000; // Tekrar deneme aralığı (3 saniye)

private async Task EnsureTokenAsync()
{
    if (Session["Token"] == null || Session["TokenExpiry"] == null || DateTime.Now >= (DateTime)Session["TokenExpiry"])
    {
        try
        {
            _token = await AcquireTokenWithRetryAsync();
            Session["Token"] = _token;
            Session["TokenExpiry"] = DateTime.Now.AddMinutes(300);
        }
        catch (Exception ex)
        {
            DisplayError($"Failed to acquire token after multiple attempts: {ex.Message}");
            return;
        }
    }
    else
    {
        _token = Session["Token"].ToString();
    }

    await FetchVmUsageDataAsync();
}

private async Task<string> AcquireTokenWithRetryAsync()
{
    for (int attempt = 0; attempt < MaxRetryAttempts; attempt++)
    {
        try
        {
            return await AcquireTokenAsync();
        }
        catch (Exception ex)
        {
            if (attempt == MaxRetryAttempts - 1)
            {
                throw; // Son denemede hata olursa, hatayı tekrar fırlat
            }

            // Bekleme süresi
            await Task.Delay(RetryDelayMilliseconds);
        }
    }
    throw new Exception("Token acquisition failed after maximum retry attempts.");
}

private async Task<string> AcquireTokenAsync()
{
    var requestUri = $"{vRopsServer}/suite-api/api/auth/token/acquire?_no_links=true";
    var requestBody = new
    {
        username = _username,
        password = _password
    };
    var jsonContent = new JavaScriptSerializer().Serialize(requestBody);
    var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");

    var response = await _httpClient.PostAsync(requestUri, content);
    if (response.IsSuccessStatusCode)
    {
        return await response.Content.ReadAsStringAsync();
    }
    else
    {
        var errorContent = await response.Content.ReadAsStringAsync();
        throw new Exception($"Failed to retrieve token: {response.ReasonPhrase}, {errorContent}");
    }
}

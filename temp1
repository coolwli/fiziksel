# Gerekli modül
Import-Module VMware.PowerCLI

# vCenter sunucularının listesi
$vcenters = @("ptekvcs01", "apgaraavcs801", "apgartstvcs201", "ptekvcsd01", "apgartksvcs201", "apgartksvcs801")

# Kullanıcı izinlerini depolamak için boş bir hash table
$userPermissions = @{}
$allRoles = @()

# Excel dosyasına yazmak için hedef yol
$exportPath = "F:\Ali\exports\service_users_report.xlsx"

# vCenter'lar üzerinde döngü
foreach ($vcenter in $vcenters) {
    Write-Host "Processing vCenter: $vcenter"

    # vCenter'a bağlan
    Connect-VIServer -Server $vcenter -User alicanda1 -Password Bytar4321

    # Kullanıcı izinlerini sıfırla
    $userPermissions = @{}

    # vCenter'daki kullanıcılar ve roller
    $vcenterUsers = Get-VIPermission | Where-Object { $_.Principal -notmatch 'vsphere' }
    foreach ($user in $vcenterUsers) {
        if (-not $userPermissions.ContainsKey($user.Principal)) {
            $userPermissions[$user.Principal] = @{}
        }

        if (-not $userPermissions[$user.Principal].ContainsKey($user.Role)) {
            $userPermissions[$user.Principal][$user.Role] = @()
        }

        $userPermissions[$user.Principal][$user.Role] += $vcenter
        $allRoles += $user.Role
    }

    # vCenter'daki cluster'lar ve izinler
    $clusters = Get-Cluster
    foreach ($cluster in $clusters) {
        $clusterPermissions = Get-Cluster $cluster | Get-VIPermission | Where-Object { $_.Principal -notmatch 'vsphere' }

        foreach ($perm in $clusterPermissions) {
            if (-not $userPermissions.ContainsKey($perm.Principal)) {
                $userPermissions[$perm.Principal] = @{}
            }

            if (-not $userPermissions[$perm.Principal].ContainsKey($perm.Role)) {
                $userPermissions[$perm.Principal][$perm.Role] = @()
            }

            $userPermissions[$perm.Principal][$perm.Role] += $cluster.Name
            $allRoles += $perm.Role
        }
    }

    # Verileri uygun formata dönüştür
    $vcenterResults = @()
    $userPermissions.GetEnumerator() | ForEach-Object {
        $user = $_.Key
        $roles = $_.Value.GetEnumerator() | ForEach-Object {
            $role = $_.Key
            $usingIn = $_.Value -join ", "

            [PSCustomObject]@{
                User     = $user
                Role     = $role
                "Using In" = $usingIn
            }
        }
        $vcenterResults += $roles
    }

    # vCenter verilerini Excel dosyasına yaz
    $vcenterResults | Export-Excel -Path $exportPath -WorksheetName $vcenter -AutoSize -Append

    # vCenter'dan çıkış yap
    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

Write-Host "Data export completed!"

$vcenters = @("ptekvcs01", "apgaraavcs801", "apgartstvcs201", "ptekvcsd01", "apgartksvcs201", "apgartksvcs801")
$vcenters = @("ptekvcs01")

$exportPath = "F:\Ali\exports\service_users_report.xlsx"

# Sonuçları depolayacağımız dizi
$results = @()

foreach ($vcenter in $vcenters) {
    Connect-VIServer -Server $vcenter -User alicanda1 -Password Bytar4321

    # vCenter kullanıcı izinlerini alıyoruz
    $vcenterUsers = Get-VIPermission | Where-Object { $_.Principal -notmatch 'vsphere' }

    foreach ($user in $vcenterUsers) {
        # Kullanıcı ve rol bilgilerini 3 sütunda depolamak için çıktı oluşturuyoruz
        $results += [PSCustomObject]@{
            User     = $user.Principal
            Role     = $user.Role
            "Using In" = $vcenter
        }
    }

    # Cluster'lar üzerindeki izinleri alıyoruz
    $clusters = Get-Cluster
    foreach ($cluster in $clusters) {
        $clusterPermissions = Get-Cluster $cluster | Get-VIPermission | Where-Object { $_.Principal -notmatch 'vsphere' }

        foreach ($perm in $clusterPermissions) {
            # Cluster bazında da aynı şekilde kullanıcı ve rol bilgilerini alıyoruz
            $results += [PSCustomObject]@{
                User     = $perm.Principal
                Role     = $perm.Role
                "Using In" = $cluster.Name
            }
        }
    }

    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

# Sonuçları Excel dosyasına aktarıyoruz
$results | Export-Excel -Path $exportPath -WorksheetName "User Permissions" -AutoSize

Write-Host "Data export completed!"

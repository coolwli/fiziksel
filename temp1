using System;
using System.IO;
using System.Web.UI;
using System.Diagnostics;
using System.Text;
using OfficeOpenXml;

public partial class UploadFile : Page
{
    protected void Page_Load(object sender, EventArgs e)
    {
    }

    protected void UploadFile(object sender, EventArgs e)
    {
        if (fileUpload.HasFile)
        {
            // Dosya türlerini kontrol et
            string fileExtension = Path.GetExtension(fileUpload.FileName).ToLower();
            if (fileExtension != ".csv" && fileExtension != ".xlsx")
            {
                Response.Write("Geçersiz dosya tipi. Lütfen CSV veya XLSX dosyası yükleyin.");
                return;
            }

            // Dosyayı güvenli bir şekilde yükle
            string uniqueFileName = Guid.NewGuid().ToString() + fileExtension;
            string filePath = Path.Combine(Server.MapPath("~/Uploads"), uniqueFileName);

            try
            {
                fileUpload.SaveAs(filePath);

                if (fileExtension == ".csv")
                {
                    // CSV dosyasını oku ve PowerShell betiğine ilet
                    string csvContent = File.ReadAllText(filePath);
                    RunPowerShellScript(csvContent);
                }
                else if (fileExtension == ".xlsx")
                {
                    // XLSX dosyasını oku ve PowerShell betiğine ilet
                    string excelContent = ReadExcelFile(filePath);
                    RunPowerShellScript(excelContent);
                }
            }
            catch (Exception ex)
            {
                Response.Write("Dosya yüklenirken bir hata oluştu: " + ex.Message);
            }
        }
    }

    private string ReadExcelFile(string filePath)
    {
        StringBuilder sb = new StringBuilder();

        try
        {
            using (var package = new ExcelPackage(new FileInfo(filePath)))
            {
                var worksheet = package.Workbook.Worksheets[0];
                int rowCount = worksheet.Dimension.Rows;
                int colCount = worksheet.Dimension.Columns;

                for (int row = 1; row <= rowCount; row++)
                {
                    for (int col = 1; col <= colCount; col++)
                    {
                        sb.Append(worksheet.Cells[row, col].Text);
                        if (col < colCount) sb.Append(",");
                    }
                    sb.AppendLine();
                }
            }
        }
        catch (Exception ex)
        {
            Response.Write("Excel dosyası işlenirken bir hata oluştu: " + ex.Message);
        }

        return sb.ToString();
    }

    private void RunPowerShellScript(string fileContent)
    {
        // PowerShell betiğinizin yolu
        string psScriptPath = @"C:\path\to\your\script.ps1";

        // PowerShell betiğine aktarılacak veriler
        string arguments = $"-ExecutionPolicy Bypass -File \"{psScriptPath}\" -InputData \"{fileContent}\"";

        ProcessStartInfo startInfo = new ProcessStartInfo()
        {
            FileName = "powershell.exe",
            Arguments = arguments,
            RedirectStandardOutput = true,
            UseShellExecute = false,
            CreateNoWindow = true
        };

        try
        {
            using (Process process = Process.Start(startInfo))
            {
                using (var reader = process.StandardOutput)
                {
                    string result = reader.ReadToEnd();
                    Response.Write("PowerShell Script Output: " + result);
                }
            }
        }
        catch (Exception ex)
        {
            Response.Write("PowerShell betiği çalıştırılırken bir hata oluştu: " + ex.Message);
        }
    }
}

$vcenters = @("ptekvcs01")
$results = @()

# Kullanıcı rol ve vCenter/Cluster ilişkilerini tutmak için bir hash
$roleColumns = @()

foreach ($vcenter in $vcenters) {
    # vCenter'a bağlan
    Connect-VIServer -Server $vcenter
    $userPermissions = @{}

    # vCenter'daki kullanıcı izinlerini al
    $vcenterUsers = Get-VIPermission | Select-Object Principal, Role
    foreach ($user in $vcenterUsers) {
        if ($user.Principal -notmatch 'vsphere') {
            if (-not $userPermissions.ContainsKey($user.Principal)) {
                $userPermissions[$user.Principal] = @{ $user.Role = $vcenter }
            } else {
                if (-not $userPermissions[$user.Principal].ContainsKey($user.Role)) {
                    $userPermissions[$user.Principal][$user.Role] = $vcenter
                }
            }
        }
    }

    # Cluster'daki kullanıcı izinlerini al
    $clusters = Get-Cluster
    foreach ($cluster in $clusters) {
        $clusterPermissions = Get-Cluster $cluster | Get-VIPermission
        foreach ($perm in $clusterPermissions) {
            if ($perm.Principal -notmatch 'vsphere') {
                if (-not $userPermissions.ContainsKey($perm.Principal)) {
                    $userPermissions[$perm.Principal] = @{ $perm.Role = $cluster.Name }
                } else {
                    if (-not $userPermissions[$perm.Principal].ContainsKey($perm.Role)) {
                        $userPermissions[$perm.Principal][$perm.Role] = $cluster.Name
                    } else {
                        $userPermissions[$perm.Principal][$perm.Role] += ", $($cluster.Name)"
                    }
                }
            }
        }
    }

    # vCenter'dan çık
    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

Name                           Value                                                                                                                                                              
----                           -----                                                                                                                                                              
GARANTI\USR_SRV_GAR_GTKGGuv... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTKGGuv... {VirtualMachinePowerUser}                                                                                                                                          
GARANTI\GT-Kampanya ve Kana... {VirtualMachineUser}                                                                                                                                               
GARANTI\GLB_GT_TSM             {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTKGSib... {VirtualMachineUser, VirtualMachinePowerUser}                                                                                                                      
GARANTI\USR_SRV_GAR_GTUOTek... {VirtualMachineUser}                                                                                                                                               
GARANTI\rbtuser36              {VirtualMachineUser}                                                                                                                                               
GARANTI\glb_gb_gpoadmins       {VirtualMachineUser}                                                                                                                                               
TEKNOLOJI\GLB_GT_PF_Depolam... {VirtualMachineUser, ReadOnly}                                                                                                                                     
GARANTI\uxdyntst               {ReadOnly}                                                                                                                                                         
GARANTI\USR_SRV_GAR_GTAIBul... {ReadOnly}                                                                                                                                                         
GARANTI\USR_SRV_GAR_GTDBMDM... {VirtualMachineUser}                                                                                                                                               
GARANTI\serviceCloudMgmtVM     {ServiceCloud}                                                                                                                                                     
GARANTI\USR_SRV_GAR_GTUOKur... {VirtualMachineUser}                                                                                                                                               
GARANTI\GLB_GT_BesDataWareH... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTNSYTu... {VirtualMachineUser, VM_User_Network_RevertSnapshot}                                                                                                               
GARANTI\USR_PC_Abacus_Otoma... {VirtualMachineUser}                                                                                                                                               
GARANTI\GT-Ortak Uygulama M... {VM_User_Network_RevertSnapshot}                                                                                                                                   
GARANTI\uxdynprd               {ReadOnly}                                                                                                                                                         
GARANTI\GLB_GT_FTP_CariMevd... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTKGSib... {VirtualMachinePowerUser}                                                                                                                                          
GARANTI\GLB_GT_PF_YerelAlan... {VirtualMachineUser}                                                                                                                                               
GARANTI\uxrun                  {VirtualMachineUser}                                                                                                                                               
GARANTI\GLB_GT_ElevatedUcKu... {MobilVeUcKullaniciTeknolojileri, VM_User_Network_RevertSnapshot, Clone of Virtual machine user (sample) + Take Snapshot, VirtualMachineUser}                      
TEKNOLOJI\GLB_GT_TSM           {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTSRSTe... {VirtualMachineUser}                                                                                                                                               
GARANTI\srv_serviceirm         {ReadOnly}                                                                                                                                                         
GARANTI\servicemonsrm          {ReadOnly}                                                                                                                                                         
GARANTI\srv_vm_unix_user       {Admin}                                                                                                                                                            
GARANTI\servicejobs            {Admin}                                                                                                                                                            
GARANTI\GT-Bireysel Emeklil... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTAIDij... {VirtualMachineUser, VirtualMachinePowerUser, ReadOnly, VPC_User}                                                                                                  
GARANTI\USR_SRV_GAR_GTAIBul... {ReadOnly, VirtualMachinePowerUser, VirtualMachineConsoleUser}                                                                                                     
GARANTI\srv_dpavmware          {ReadOnly}                                                                                                                                                         
GARANTI\USR_SRV_GAR_GTAIBul... {VirtualMachineUser}                                                                                                                                               
GARANTI\GLB_GT_PF_Hazine_ve... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTAIDij... {VirtualMachineUser}                                                                                                                                               
GARANTI\POL_GB_VPC_SelfServ... {VPC_SelfService_PowerOn}                                                                                                                                          
GARANTI\GLB_GB_VMwareClient    {VirtualMachineUser}                                                                                                                                               
GARANTI\uxvmware               {ReadOnly}                                                                                                                                                         
GARANTI\serviceilmt            {ReadOnly}                                                                                                                                                         
GARANTI\GLB_GB_TS_STEP_TEST... {VirtualMachineUser}                                                                                                                                               
GARANTI\GLB_GT_Sqlteam         {VM_User_Network_RevertSnapshot}                                                                                                                                   
GARANTI\srv_serviceassetpoc    {ReadOnly}                                                                                                                                                         
GARANTI\USR_SRV_GAR_GTNSYGe... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTVPYTO... {VirtualMachineUser, VirtualMachinePowerUser}                                                                                                                      
GARANTI\USR_SRV_GAR_GTBTGRY... {VirtualMachineUser}                                                                                                                                               
GARANTI\ADM_GT_Helpdesk_Gar... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTKGGuv... {VirtualMachineUser}                                                                                                                                               
GARANTI\USR_SRV_GAR_GTAIDij... {MobilVeUcKullaniciTeknolojileri, VirtualMachinePowerUser} 

 
$apiKey = "8G7kTdsDJLqEVLuGFGHgBC2BxFx4AsQpkKMVQvxrrKd2R0Fc83GNJQQJ99BDACfhMk5XJ3w3AAABACOGVRgB" # Azure OpenAI API anahtarınızı buraya ekleyin
$endpoint = "https://openai-swe-bulutaltyapi.openai.azure.com/openai/deployments/gpt-4.1-bulutaltyapi/chat/completions?api-version=2025-01-01-preview" # Endpoint URL'nizi buraya ekleyin
 
# CSV dosyasını oku
$csvFilePath = "./reclaim_api_test.csv"
$data = Import-Csv -Path $csvFilePath

# Batch ayarları
$batchSize = 1000
$allResults = @()
 
 
for ($i = 0; $i -lt $csvData.Count; $i += $batchSize) {
    $endIndex = if (($i + $batchSize - 1) -lt $data.Count) { $i + $batchSize - 1 } else { $data.Count - 1 }
    $batch = $data[$i..$endIndex]

    # Batch'i JSON'a çevir
    $batchJson = $batch | ConvertTo-Json -Depth 10

    
    # Prompt'u oluştur
    $prompt = @"
    You are an expert in VMware virtual machine (VM) performance and capacity optimization.

    You will be given a dataset in Excel format that includes information about virtual machines. Each row contains the following columns:
        1.	Hostname of the VM
        2.	Number of vCPUs allocated
        3.	Average CPU usage (%) over the last 3 months
        4.	95th percentile CPU usage (%)
        5.	99th percentile CPU usage (%)
        6.	Memory allocated (in GB)
        7.	Average memory usage (%)
        8.	95th percentile memory usage (%)
        9.	99th percentile memory usage (%)

    Your task is to analyze each VM in the dataset and provide optimized resource recommendations. The goal is to safely reclaim overallocated resources without compromising performance, even during usage spikes.

    For each VM in $batchContent, generate the following fields:
        •	VMName: Same as input
        •	CurrentCPU: Same as input
        •	ReclaimScoreCPU: A number from 0 to 100 indicating CPU overallocation
        •	SuggestedCPU: New CPU count. Must be >= 95th percentile CPU demand. Suggest a lower CPU allocation only if it’s safe and conservative
        •	CurrentMemory: Same as input
        •	ReclaimScoreMemory: A number from 0 to 100 indicating memory overallocation
        •	SuggestedMemory: New memory size in GB. Must be >= 95th percentile memory usage, minimum 4 GB, rounded to nearest even number. Suggest less only if safe

    Rules:
        •	Reclaim scores should reflect how much can safely be reclaimed: 0 = no reclaim, 100 = full overallocation
        •	Suggested values must be cautious and avoid performance risk during spikes
        •	Do not reduce resources below peak (95th percentile) usage
        •	Be conservative in recommendations

    Output format: Return results in a JSON array. Do not include others.

"@
    
    # JSON body oluştur
    $body = @{
        messages = @(
            @{
                role = "system"
                content = "You are an expert in VMware virtual machine (VM) performance and capacity optimization."
            },
            @{
                role = "user"
                content = $prompt
            }
        )
        temperature = 0.7
    } | ConvertTo-Json -Depth 10

    # HTTP başlıkları
    $headers = @{
        "Content-Type" = "application/json"
        "api-key" = $apiKey
    }

    # API'ye gönder
    try {
        $response = Invoke-RestMethod -Uri $endpoint -Method Post -Headers $headers -Body $body
        $answer = $response.choices[0].message.content
        $allResults += $answer
        Write-Host "Batch $($i / $batchSize + 1) işlendi." 
    } catch {
        Write-Host "Hata oluştu: $($_.Exception.Message)"
    }

    Start-Sleep -Seconds 2
}

# Sonuçları bir dosyaya yaz
$allResults | Set-Content -Path ".\all_results.json"

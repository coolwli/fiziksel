# Konfigürasyon ve Sabitler
$TokenLifetime = [TimeSpan]::FromHours(3)
$VropsServer = "https://ptekvrops01.fw.garanti.com.tr"
$TokenType = "pendik"
$OpsNamespace = "http://webservice.vmware.com/vRealizeOpsMgr/1.0/"
$ConnectionString = "Data Source=TEKSCR1\SQLEXPRESS;Initial Catalog=CloudUnited;Integrated Security=True"

# Kullanıcı Bilgileri
$Username = "yourUsername"
$Password = "yourPassword"

# Genel Hata Yönetimi İçin Basit Yardımcı Fonksiyon
function Handle-Error {
    param([string]$message)
    Write-Error "Hata: $message"
    exit 1
}

# Token alma fonksiyonu
function Acquire-Token {
    try {
        $requestUri = "$VropsServer/suite-api/api/auth/token/acquire?_no_links=true"
        $requestBody = @{
            username = $Username
            password = $Password
        } | ConvertTo-Json

        $response = Invoke-RestMethod -Uri $requestUri -Method Post -Body $requestBody -ContentType "application/json"
        
        if ($response.token) {
            return $response.token
        } else {
            Handle-Error "Token alınamadı. Lütfen kullanıcı adı ve şifreyi kontrol edin."
        }
    } catch {
        Handle-Error "Token alınırken bir hata oluştu: $_"
    }
}

# Token'ı XML'den çıkarmak için fonksiyon
function Extract-TokenFromXml {
    param([string]$xmlData)
    try {
        $xml = [xml]$xmlData
        $tokenElement = $xml.SelectSingleNode("//token")
        return $tokenElement?.InnerText
    } catch {
        Handle-Error "Token XML'den çıkarılamadı: $_"
    }
}

# Veriyi almak için API çağrısı yapan fonksiyon
function Get-Data {
    param([string]$token)
    
    try {
        $getIdUrl = "$VropsServer/suite-api/internal/views/e5bb44f3-f7d8-45c5-8819-dfc6e7672463/data/export?resourceId=00330e14-5263-4728-8273-a135ae4d22fa&pageSize=10000&traversalSpec=vSphere Hosts and Clusters-VMWARE-vSphere World&_ack=true"
        
        $headers = @{
            "Authorization" = "vRealizeOpsToken $token"
        }

        $response = Invoke-RestMethod -Uri $getIdUrl -Headers $headers -Method Get
        
        if ($response) {
            return $response
        } else {
            Handle-Error "Veri alınamadı."
        }
    } catch {
        Handle-Error "Veri alınırken bir hata oluştu: $_"
    }
}

# Veritabanından Token bilgisini okuma fonksiyonu
function Read-TokenInfo {
    param([string]$tokenType)
    
    try {
        $query = "SELECT Token, ExpiryDate FROM TokenInfo WHERE TokenType = @TokenType"
        $connection = New-Object System.Data.SqlClient.SqlConnection($ConnectionString)
        $command = $connection.CreateCommand()
        $command.CommandText = $query
        $command.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@TokenType",[Data.SqlDbType]::VarChar, 50))).Value = $tokenType

        $connection.Open()

        $reader = $command.ExecuteReader()
        $tokenInfo = @{}

        if ($reader.Read()) {
            $tokenInfo["Token"] = $reader["Token"]
            $tokenInfo["ExpiryDate"] = $reader["ExpiryDate"]
        }

        $connection.Close()
        return $tokenInfo
    } catch {
        Handle-Error "Veritabanından token bilgisi okunurken bir hata oluştu: $_"
    }
}

# Token bilgisini veritabanına kaydetme fonksiyonu
function Store-TokenInfo {
    param([string]$tokenType, [string]$token, [datetime]$expiryDate)

    try {
        $query = @"
        IF EXISTS (SELECT 1 FROM TokenInfo WHERE TokenType = @TokenType)
        BEGIN
            UPDATE TokenInfo SET Token = @Token, ExpiryDate = @ExpiryDate WHERE TokenType = @TokenType
        END
        ELSE
        BEGIN
            INSERT INTO TokenInfo (TokenType, Token, ExpiryDate) VALUES (@TokenType, @Token, @ExpiryDate)
        END
    "@
        $connection = New-Object System.Data.SqlClient.SqlConnection($ConnectionString)
        $command = $connection.CreateCommand()
        $command.CommandText = $query

        $command.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@TokenType",[Data.SqlDbType]::VarChar, 50))).Value = $tokenType
        $command.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@Token",[Data.SqlDbType]::VarChar, 500))).Value = $token
        $command.Parameters.Add((New-Object Data.SqlClient.SqlParameter("@ExpiryDate",[Data.SqlDbType]::DateTime))).Value = $expiryDate

        $connection.Open()
        $command.ExecuteNonQuery()
        $connection.Close()
    } catch {
        Handle-Error "Token bilgisi veritabanına kaydedilirken bir hata oluştu: $_"
    }
}

# Token'ın geçerliliğini kontrol etme ve veri çekme fonksiyonu
function Check-TokenAndFetchData {
    param([string]$tokenType)

    # Mevcut Token'ı veritabanından okuma
    $tokenInfo = Read-TokenInfo -tokenType $tokenType

    # Token süresi dolmuşsa, yeni token al
    if ($tokenInfo["ExpiryDate"] -le (Get-Date)) {
        Write-Host "Token süresi dolmuş. Yeni token alınıyor..."
        $newToken = Acquire-Token
        if ($newToken) {
            Store-TokenInfo -tokenType $tokenType -token $newToken -expiryDate (Get-Date).Add($TokenLifetime)
            return Get-Data -token $newToken
        }
        return "Token alınamadı."
    }

    # Token geçerli ise süresini uzat ve veri al
    Write-Host "Token geçerli. Süresi uzatılıyor..."
    Store-TokenInfo -tokenType $tokenType -token $tokenInfo["Token"] -expiryDate (Get-Date).Add($TokenLifetime)
    return Get-Data -token $tokenInfo["Token"]
}

# Main fonksiyonu çağırma
try {
    $data = Check-TokenAndFetchData -tokenType $TokenType

    if ($data) {
        Write-Host "Veri başarıyla alındı."
        # Burada veriyi işleyebilirsiniz
    } else {
        Handle-Error "Veri alınamadı."
    }
} catch {
    Handle-Error "Ana işlem sırasında bir hata oluştu: $_"
}

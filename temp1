# Fonksiyon tanımı
function Connect-ToVCenter {
    param (
        [string]$VCenterServer,
        [string]$Username,
        [string]$Password
    )
    
    try {
        # vCenter'a bağlanma
        Connect-VIServer -Server $VCenterServer -User $Username -Password $Password -ErrorAction Stop
        # Bağlantı sağlandıktan sonra basit bir işlem gerçekleştirme
        $datacenters = Get-Datacenter
        Disconnect-VIServer -Server $VCenterServer -Confirm:$false
        return "$VCenterServer bağlantısı başarılı"
    } catch {
        return "$VCenterServer bağlantısı başarısız: $_"
    }
}

# Paralel işlem bloğu
$VCenterServer = "vcenter.example.com"
$Username = "admin"
$Password = "password"
$instances = 1..30
$results = $instances | ForEach-Object -Parallel {
    param ($instance, $VCenterServer, $Username, $Password, $function)

    # Fonksiyonu çağır
    $result = & $function -VCenterServer $VCenterServer -Username $Username -Password $Password
    return $result

} -ThrottleLimit 30 -ArgumentList $using:VCenterServer, $using:Username, $using:Password, $using:Connect-ToVCenter

# Sonuçları yazdır
$results | ForEach-Object { Write-Output $_ }

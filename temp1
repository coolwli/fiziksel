# Gerekli modülü yükle (Modülün yüklü olduğundan emin olmalısınız)
# Install-Module -Name ImportExcel -Force -Scope CurrentUser

$vcenters = @("01", "02", "03", "04", "05", "06")

# Excel raporu için bir nesne oluşturuyoruz
$excelReport = @{}

foreach ($vcenter in $vcenters) {
    # Her vCenter için bağlantıyı kuruyoruz
    Connect-VIServer -Server $vcenter

    $report = @()

    # vCenter kullanıcılarını alıyoruz
    $vcenterUsers = Get-VIPermission | Select-Object Principal, Role

    $vcenterUsers | ForEach-Object {
        # Kullanıcı adı "\vsphere" içeriyorsa, o kullanıcıyı hariç tutuyoruz
        if ($_..Principal -notmatch '\\vsphere') {
            $report += [PSCustomObject]@{
                Domain    = $vcenter
                Principal  = $_.Principal
                Role       = $_.Role
                Inherited  = $false
            }
        }
    }

    # Cluster'ları alıyoruz
    $clusters = Get-Cluster

    foreach ($cluster in $clusters) {
        $clusterPermissions = Get-Cluster $cluster | Get-VIPermission
        foreach ($perm in $clusterPermissions) {
            $isInherited = ($perm.EntityId -ne $cluster.Id)

            # Kullanıcı adı "\vsphere" içeriyorsa, o kullanıcıyı hariç tutuyoruz
            if ($perm.Principal -notmatch '\\vsphere') {
                $report += [PSCustomObject]@{
                    Domain    = $cluster.Name
                    Principal  = $perm.Principal
                    Role       = $perm.Role
                    Inherited  = $isInherited
                }
            }
        }
    }

    # Sonuçları Excel raporuna ekliyoruz
    $excelReport[$vcenter] = $report

    # vCenter bağlantısını kapatıyoruz
    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

# Sonuçları Excel dosyasına yazıyoruz
$excelReport.GetEnumerator() | ForEach-Object {
    $vcenter = $_.Key
    $data = $_.Value

    # Veriyi her vCenter için ayrı bir sayfada kaydediyoruz
    $data | Export-Excel -Path "C:\path\to\your\report.xlsx" -WorksheetName $vcenter -Append
}

Write-Host "Raporlar başarıyla Excel dosyasına yazıldı."

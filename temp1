$jsonPath = "C:\Users\AliCanda\Documents\calismalar\ai\analyze\VMsMetrics.json"
$apiKey = "8G7kTdsDJLqEVLuGFGHgBC2BxFx4AsQpkKMVQvxrrKd2R0Fc83GNJQQJ99BDACfhMk5XJ3w3AAABACOGVRgB"
$endpoint = "https://openai-swe-bulutaltyapi.openai.azure.com/openai/responses?api-version=2025-04-01-preview"

$vmMetrikleri = Get-Content $jsonPath | ConvertFrom-Json

# Detailed prompts per metric category
$kategoriPromptlari = @{
    "cpu" = @"
        This dataset contains key CPU-related performance metrics for virtual machines, including:
        - `cpu|usage_average`: the average CPU utilization percentage over time.
        - `cpu|demandPct`: the percentage of CPU resources requested by the VM.
        - `cpu|readyPct`: the percentage of time the VM is ready to execute but cannot get scheduled on a physical CPU.
        - `guest|cpu_queue`: the number of processes waiting in the CPU queue.

        High `readyPct` or `cpu_queue` values may indicate CPU contention or oversubscription. Analyze trends, peak usage, and saturation risks. Identify if vCPU overcommitment or under-allocation may be causing performance bottlenecks.
"@;

    "memory" = @"
        This dataset contains memory-related performance metrics for virtual machines, such as:
        - `mem|usage_average`: average memory utilization as a percentage.
        - `mem|swapoutRate_average` and `mem|swapinRate_average`: show the rate at which memory pages are swapped out/in, indicating memory pressure.
        - `mem|balloonPct`: percentage of memory reclaimed by the balloon driver, typically under host memory pressure.

        A healthy VM should show low or zero swap and ballooning activity. Analyze trends for memory saturation, excessive usage, and potential reclaim opportunities. Identify inefficient memory use, memory overcommitment, or misconfigured limits.
"@;

    "disk" = @"
        This dataset includes virtual disk I/O performance metrics, including:
        - `virtualDisk|read_average` and `virtualDisk|write_average`: average read and write Disk I/O operations in milliseconds.
        - `virtualDisk:Aggregate of all instances|totalLatency`: total latency across all disk instances.

        Disk latency above 20â€“30 ms can impact application performance. Identify patterns of disk bottlenecks, I/O pressure, and usage peaks. Look for consistently high latencies or unusual spikes that could signal underlying storage issues.
"@;

    "network" = @"
        This dataset contains network performance data for virtual machines, including:
        - `net|transmitted_average` and `net|received_average`: average network throughput in KB/s.
        - `net:Aggregate of all instances|droppedPct`: percentage of packets dropped.

        Packet drops, even at low rates, can indicate congestion or network misconfiguration. Analyze the balance of ingress and egress traffic. Detect abnormal patterns, such as traffic bursts, loss spikes, or sustained saturation levels.
"@;

}

# AI API wrapper function
function Send-ToAIAnalysis {
    param(
        [string]$kategoriAdi,
        [array]$metrikler
    )

    $jsonPayload = $metrikler | ConvertTo-Json -Depth 5

    $aiPrompt = @"
        Below is long-term resource usage data for a virtual machine (VM), collected at 1-hour intervals via the vROps API.

        Please analyze the data with expert-level insight:

        Identify and interpret usage trends (increases, decreases, fluctuations).

        Detect changes in resource intensity and any anomalies.

        Highlight periods of underutilization or sudden shifts.

        Assess whether current resource allocation is sufficient.

        Provide recommendations on scaling, reduction, or reallocation if needed.

        Suggest proactive measures or necessary actions.
        $($kategoriPromptlari[$kategoriAdi])
        $jsonPayload

        Summarize all findings in a concise paragraph of up to 50 words, including technical justifications.
"@

    Write-Host "=== $kategoriAdi Analizi ===" -ForegroundColor Cyan

    $body = @{
        messages = @(
            @{
                role = "system"
                content = "You are a VMWare Infrastructure cloud-resources optimization expert."
            },
            @{
                role = "user"
                content = $aiPrompt
            }
        )
        temperature = 0.3
        max_tokens = 4000
    } | ConvertTo-Json -Depth 10 -Compress

    $headers = @{
        "Content-Type" = "application/json"
        "api-key" = $apiKey
    }

    try {
        $response = Invoke-RestMethod -Uri $endpoint -Method Post -Headers $headers -Body $body
        $answer = $response.choices[0].message.content
        return $answer
    } catch {
        return "Error occurred: $($_.Exception.Message)"
    }
}

# Main analysis loop
$analizSonuclari = @{}

foreach ($vm in $vmMetrikleri.PSObject.Properties) {
    $vmAdi = $vm.Name
    $kategorilereAyrilmisMetrikler = $vm.Value
    $analizSonuclari[$vmAdi] = @{}
    Write-Host $vmAdi -ForegroundColor Red
    foreach ($kategori in $kategorilereAyrilmisMetrikler.PSObject.Properties) {
        if ($kategorilereAyrilmisMetrikler.($kategori.Name).Count -gt 0) {
            $kategoriAdi = $kategori.Name
            $metrikler = $kategori.Value
            $analizSonuclari[$vmAdi][$kategoriAdi] = Send-ToAIAnalysis -kategoriAdi $kategoriAdi -metrikler $metrikler
        } else {
            Write-Host "No data found for $($kategori.Name)." -ForegroundColor Red
        }
    }
}

# Save results
$jsonOutput = $analizSonuclari | ConvertTo-Json -Depth 5
$outputFilePath = "C:\Users\AliCanda\Documents\calismalar\ai\analyze\VMsMetricsOutput.json"
Set-Content -Path $outputFilePath -Value $jsonOutput -Encoding UTF8
Write-Host "Metrics saved to $outputFilePath"

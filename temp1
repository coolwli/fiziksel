using System;
using System.Threading.Tasks;
using System.IO;
using System.Net.Http;
using System.Text;
using System.Linq;
using System.Collections.Generic;
using System.Net.Security;
using System.Security.Cryptography.X509Certificates;
using System.Xml.Linq;
using Newtonsoft.Json;

namespace blank_page
{
    public partial class _default : System.Web.UI.Page
    {
        private const string VropsServer = "https://ptekvrops01.fw.garanti.com.tr";
        private const string OpsNamespace = "http://webservice.vmware.com/vRealizeOpsMgr/1.0/";
        private readonly string _token = "f267bd72-f77d-43ee-809c-c081d9a62dbe::a4ccbe4a-e9b6-4e01-92dd-0930cb99e2ac";
        private readonly string[] _initialMetricsToFilter = { "cpu|usage_average", "mem|usage_average" };
        private List<string> _metricsToFilter;
        private static readonly HttpClient _httpClient = new HttpClient();

        protected async void Page_Load(object sender, EventArgs e)
        {
            ServicePointManager.ServerCertificateValidationCallback += ValidateServerCertificate;
            await FetchVmUsageDataAsync();
        }

        private static bool ValidateServerCertificate(object sender, X509Certificate certificate, X509Chain chain, SslPolicyErrors sslPolicyErrors)
        {
            // Ensure proper certificate validation in production
            return sslPolicyErrors == SslPolicyErrors.None;
        }

        private async Task FetchVmUsageDataAsync()
        {
            try
            {
                string vmId = await GetVmIdAsync("gbsplp27");
                if (!string.IsNullOrEmpty(vmId))
                {
                    await FetchGuestFileSystemMetricsAsync(vmId);

                    var startTimeMillis = new DateTimeOffset(DateTime.UtcNow.AddDays(-365)).ToUnixTimeMilliseconds();
                    var endTimeMillis = new DateTimeOffset(DateTime.UtcNow).ToUnixTimeMilliseconds();

                    var metricsData = await FetchAllMetricsAsync(vmId, startTimeMillis, endTimeMillis);

                    SendUsageDataToClient(metricsData, new DateTime[] {}); // Pass appropriate timestamps if needed
                }
                else
                {
                    DisplayMessage("VM ID not found.");
                }
            }
            catch (Exception ex)
            {
                DisplayMessage($"Error fetching VM data: {ex.Message}");
            }
        }

        private async Task FetchGuestFileSystemMetricsAsync(string vmId)
        {
            long startTimeMillis = new DateTimeOffset(DateTime.UtcNow.AddHours(-1)).ToUnixTimeMilliseconds();
            long endTimeMillis = new DateTimeOffset(DateTime.UtcNow).ToUnixTimeMilliseconds();
            string statsUrl = $"{VropsServer}/suite-api/api/resources/{vmId}/stats?begin={startTimeMillis}&end={endTimeMillis}&intervalQuantifier=1&intervalType=HOURS&rollUpType=AVG";
            var request = new HttpRequestMessage(HttpMethod.Get, statsUrl);
            request.Headers.Add("Authorization", $"vRealizeOpsToken {_token}");

            using (var response = await _httpClient.SendAsync(request))
            {
                response.EnsureSuccessStatusCode();
                string responseText = await response.Content.ReadAsStringAsync();
                var xmlDoc = XDocument.Parse(responseText);
                var ns = xmlDoc.Root.GetNamespaceOfPrefix("ops");

                var stats = xmlDoc.Descendants(XName.Get("stat", ns.NamespaceName));
                _metricsToFilter = new List<string>(_initialMetricsToFilter);

                foreach (var stat in stats)
                {
                    var key = stat.Element(XName.Get("statKey", ns.NamespaceName))
                                  .Element(XName.Get("key", ns.NamespaceName))
                                  .Value;

                    if (key.StartsWith("guestfilesystem") && key.EndsWith("|percentage"))
                    {
                        _metricsToFilter.Add(key);
                    }
                }
            }
        }

        private async Task<Dictionary<string, double[]>> FetchAllMetricsAsync(string vmId, long startTimeMillis, long endTimeMillis)
        {
            var fetchTasks = _metricsToFilter.Select(async metric =>
            {
                var metricsUrl = $"{VropsServer}/suite-api/api/resources/{vmId}/stats?statKey={metric}&begin={startTimeMillis}&end={endTimeMillis}&intervalQuantifier=5&intervalType=MINUTES&rollUpType=AVG";
                var data = await FetchMetricsDataAsync(metricsUrl);
                var parsedData = ParseMetricsData(data, metric);
                return new { metric, data = parsedData };
            });

            var results = await Task.WhenAll(fetchTasks);

            return results.Where(result => result.data != null)
                          .ToDictionary(result => result.metric, result => result.data);
        }

        private async Task<string> FetchMetricsDataAsync(string url)
        {
            try
            {
                var request = new HttpRequestMessage(HttpMethod.Get, url);
                request.Headers.Add("Authorization", $"vRealizeOpsToken {_token}");

                using (var response = await _httpClient.SendAsync(request))
                {
                    response.EnsureSuccessStatusCode();
                    return await response.Content.ReadAsStringAsync();
                }
            }
            catch (HttpRequestException ex)
            {
                throw new ApplicationException("Error fetching metrics data.", ex);
            }
        }

        private double[] ParseMetricsData(string xmlData, string metricKey)
        {
            var metrics = new List<double>();
            var nsManager = new XmlNamespaceManager(new NameTable());

            using (var reader = XmlReader.Create(new StringReader(xmlData)))
            {
                while (reader.Read())
                {
                    if (reader.IsStartElement("stat"))
                    {
                        var key = reader["key"];
                        if (key == metricKey)
                        {
                            reader.ReadToFollowing("data");
                            var data = reader.ReadElementContentAsString();
                            metrics = data.Split(' ')
                                .Select(d => double.TryParse(d, out var value) ? value : 0.0)
                                .ToList();
                        }
                    }
                }
            }

            return metrics.ToArray();
        }

        private async Task<string> GetVmIdAsync(string vmName)
        {
            string getIdUrl = $"{VropsServer}/suite-api/api/resources?resourceKind=VirtualMachine&name={vmName}";

            var request = new HttpRequestMessage(HttpMethod.Get, getIdUrl);
            request.Headers.Add("Authorization", $"vRealizeOpsToken {_token}");

            using (var response = await _httpClient.SendAsync(request))
            {
                response.EnsureSuccessStatusCode();
                string responseText = await response.Content.ReadAsStringAsync();
                var xmlDoc = XDocument.Parse(responseText);

                var ns = xmlDoc.Root.GetNamespaceOfPrefix("ops");
                var identifier = xmlDoc.Descendants(XName.Get("resource", ns.NamespaceName))
                                       .Select(r => r.Attribute("identifier")?.Value)
                                       .FirstOrDefault();
                return identifier;
            }
        }

        private void SendUsageDataToClient(Dictionary<string, double[]> metricsData, DateTime[] timestamps)
        {
            var jsonData = new
            {
                dates = timestamps.Select(t => t.ToString("yyyy-MM-ddTHH:mm:ss")).ToArray(),
                metrics = metricsData.ToDictionary(
                    kvp => kvp.Key,
                    kvp => kvp.Value.Select(v => v.ToString("F2")).ToArray()
                )
            };

            var jsonString = JsonConvert.SerializeObject(jsonData);

            var script = $"var usageData = JSON.parse('{jsonString}'); fetchData();";
            ClientScript.RegisterStartupScript(this.GetType(), "usageDataScript", script, true);
        }

        private void DisplayMessage(string message) => Label.InnerText = message;
    }
}

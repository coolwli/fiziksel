## Ignore SSL Certificates
add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy

$token=(F:\Ali\powershell\vrops\getVropsToken.ps1 -tokenType "pendik")

if($token -eq $null){
    return "token is null"
}
$headers = @{
    "Content-Type" = "application/json"
    "Authorization" = "vRealizeOpsToken $token"
}


$reportsUrl = "https://ptekvrops01.fw.garanti.com.tr/suite-api/api/resources/d5657a0c-d1e7-4659-95d4-88daa2530e68/stats?&intervalType=HOURS&rollUpType=AVG&begin=1748083781000&end=1750762181000"

$reportsResponse = Invoke-RestMethod -Method Get -Uri $reportsUrl -Headers $headers -ContentType "application/json"

# Metrikleri kategorilere ayır
$metrikKategorileri = @{
    "CPU_Metrikleri" = @(
        "cpu|capacity_usagepct_average"
    )
    "Bellek_Metrikleri" = @(
        "mem|usage_average","mem|sysUsage_average"
    )
    "Disk_Metrikleri" = @(
        "net|usage_average"
    )
    "Network_Metrikleri" = @(
        "disk|usage_average"
    )
}

# Her kategori için ayrı veri yapısı
$kategorilereAyrilmisMetrikler = @{}

# Kategorileri başlat
foreach ($kategori in $metrikKategorileri.Keys) {
    $kategorilereAyrilmisMetrikler[$kategori] = @()
}

# Tüm statları kontrol et ve kategorilere ayır
foreach ($stat in $reportsResponse.'stats-of-resources'.'stats-of-resource'.'stat-list'.stat) {
    foreach ($kategoriAdi in $metrikKategorileri.Keys) {
        if ($metrikKategorileri[$kategoriAdi] -contains $stat.statKey.key) {
            $kategorilereAyrilmisMetrikler[$kategoriAdi] += [PSCustomObject]@{
                StatKey = $stat.statKey.key
                Value = $stat.data
            }
            break
        }
    }
}
$jsonOutput = $kategorilereAyrilmisMetrikler | ConvertTo-Json -Depth 10
$outputFilePath = "F:\Ali\kategorilereAyrilmisMetrikler.json"
Set-Content -Path $outputFilePath -Value $jsonOutput -Encoding UTF8

Write-Host "Metrics saved to $outputFilePath"

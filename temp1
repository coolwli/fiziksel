$jsonPath = "C:\Users\AliCanda\Documents\calismalar\VMsMetrics.json"
$apiKey = "8G7kTdsDJLqEVLuGFGHgBC2BxFx4AsQpkKMVQvxrrKd2R0Fc83GNJQQJ99BDACfhMk5XJ3w3AAABACOGVRgB"
$endpoint = "https://openai-swe-bulutaltyapi.openai.azure.com/openai/deployments/gpt-4.1-bulutaltyapi/chat/completions?api-version=2025-01-01-preview"

$vmMetrikleri = Get-Content $jsonPath | ConvertFrom-Json

# Detailed prompts per metric category
$kategoriPromptlari = @{
    "CPU_Metrikleri" = @"
This dataset contains key CPU-related performance metrics for virtual machines, including:
- `cpu|usage_average`: the average CPU utilization percentage over time.
- `cpu|demandPct`: the percentage of CPU resources requested by the VM.
- `cpu|readyPct`: the percentage of time the VM is ready to execute but cannot get scheduled on a physical CPU.
- `guest|cpu_queue`: the number of processes waiting in the CPU queue.

High `readyPct` or `cpu_queue` values may indicate CPU contention or oversubscription. Analyze trends, peak usage, and saturation risks. Identify if vCPU overcommitment or under-allocation may be causing performance bottlenecks.
"@;

    "Bellek_Metrikleri" = @"
This dataset contains memory-related performance metrics for virtual machines, such as:
- `mem|usage_average`: average memory utilization as a percentage.
- `mem|swapoutRate_average` and `mem|swapinRate_average`: show the rate at which memory pages are swapped out/in, indicating memory pressure.
- `mem|balloonPct`: percentage of memory reclaimed by the balloon driver, typically under host memory pressure.

A healthy VM should show low or zero swap and ballooning activity. Analyze trends for memory saturation, excessive usage, and potential reclaim opportunities. Identify inefficient memory use, memory overcommitment, or misconfigured limits.
"@;

    "Disk_Metrikleri" = @"
This dataset includes virtual disk I/O performance metrics, including:
- `virtualDisk|read_average` and `virtualDisk|write_average`: average latency of read and write operations in milliseconds.
- `virtualDisk:Aggregate of all instances|totalLatency`: total latency across all disk instances.

Disk latency above 20â€“30 ms can impact application performance. Identify patterns of disk bottlenecks, I/O pressure, and usage peaks. Look for consistently high latencies or unusual spikes that could signal underlying storage issues.
"@;

    "Network_Metrikleri" = @"
This dataset contains network performance data for virtual machines, including:
- `net|transmitted_average` and `net|received_average`: average network throughput in KB/s or MB/s.
- `net:Aggregate of all instances|droppedPct`: percentage of packets dropped.

Packet drops, even at low rates, can indicate congestion or network misconfiguration. Analyze the balance of ingress and egress traffic. Detect abnormal patterns, such as traffic bursts, loss spikes, or sustained saturation levels.
"@;

    "Performans_Metrikleri" = @"
This dataset includes system-level performance metrics that may include uptime, power usage, and throttling or capping information. These values help assess overall system health and efficiency. Use them to identify environmental constraints or long-term degradation risks.
"@
}

# AI API wrapper function
function Send-ToAIAnalysis {
    param(
        [string]$kategoriAdi,
        [array]$metrikler
    )

    $jsonPayload = $metrikler | ConvertTo-Json -Depth 5

    $aiPrompt = @"
$($kategoriPromptlari[$kategoriAdi])

Below is long-term resource utilization data for a virtual machine (VM).
The data has been collected via the vROps API at 1-hour intervals.

Please analyze the data according to the following steps:

1. General Trend and Utilization Analysis:
   - Identify and interpret usage trends (e.g., increases, decreases, fluctuations).
   - Evaluate how resource utilization intensity has changed over time.

2. Anomaly Detection:
   - Detect any sudden spikes, drops, or unusual patterns in usage.
   - Indicate the specific time periods where anomalies are concentrated.

3. Capacity and Risk Analysis:
   - Identify periods of excessive or insufficient resource usage.
   - Based on long-term usage statistics, assess whether the current resource allocation is sufficient.
   - Would you recommend reclaiming any underutilized resources?

4. Recommendations:
   - Provide suggestions to increase, decrease, or reconfigure the current resource allocation.
   - If necessary, outline proactive measures or actions that should be taken.

Please summarize all findings in a single, detailed paragraph, including technical insights and justifications for each conclusion.

Respond in Turkish please. But do not use Turkish characters.
"@

    Write-Host "=== $kategoriAdi Analizi ===" -ForegroundColor Cyan

    $body = @{
        messages = @(
            @{
                role = "system"
                content = "You are a cloud-resources optimization assistant."
            },
            @{
                role = "user"
                content = $aiPrompt
            }
        )
        temperature = 0.3
        max_tokens = 4000
    } | ConvertTo-Json -Depth 10 -Compress

    $headers = @{
        "Content-Type" = "application/json"
        "api-key" = $apiKey
    }

    try {
        $response = Invoke-RestMethod -Uri $endpoint -Method Post -Headers $headers -Body $body
        $answer = $response.choices[0].message.content
        return $answer
    } catch {
        return "Error occurred: $($_.Exception.Message)"
    }
}

# Main analysis loop
$analizSonuclari = @{}

foreach ($vm in $vmMetrikleri.PSObject.Properties) {
    $vmAdi = $vm.Name
    $kategorilereAyrilmisMetrikler = $vm.Value
    $analizSonuclari[$vmAdi] = @{}
    foreach ($kategori in $kategorilereAyrilmisMetrikler.PSObject.Properties) {
        if ($kategorilereAyrilmisMetrikler.($kategori.Name).Count -gt 0) {
            $kategoriAdi = $kategori.Name
            $metrikler = $kategori.Value
            Write-Host "Processing $kategoriAdi..." -ForegroundColor Magenta
            $analizSonuclari[$vmAdi][$kategoriAdi] = Send-ToAIAnalysis -kategoriAdi $kategoriAdi -metrikler $metrikler
        } else {
            Write-Host "No data found for $($kategori.Name)." -ForegroundColor Red
        }
    }
}

# Save results
$jsonOutput = $analizSonuclari | ConvertTo-Json -Depth 5
$outputFilePath = "C:\Users\AliCanda\Documents\calismalar\VMsMetricsOutput.json"
Set-Content -Path $outputFilePath -Value $jsonOutput -Encoding UTF8
Write-Host "Metrics saved to $outputFilePath"

$jsonPath="C:\Users\AliCanda\Documents\calismalar\VMsMetrics.json"
$apiKey = "8G7kTdsDJLqEVLuGFGHgBC2BxFx4AsQpkKMVQvxrrKd2R0Fc83GNJQQJ99BDACfhMk5XJ3w3AAABACOGVRgB" # Azure OpenAI API anahtarınızı buraya ekleyin
$endpoint = "https://openai-swe-bulutaltyapi.openai.azure.com/openai/deployments/gpt-4.1-bulutaltyapi/chat/completions?api-version=2025-01-01-preview" # Endpoint URL'nizi buraya ekleyin
 
$vmMetrikleri = Get-Content $jsonPath | ConvertFrom-Json

# AI API fonksiyonu (bu kısım sizin AI API'nize göre ayarlanmalı)
function Send-ToAIAnalysis {
    param(
        [string]$kategoriAdi,
        [array]$metrikler
    )
    
    # JSON formatına çevir
    $jsonPayload = $metrikler | ConvertTo-Json

    # Category-specific prompts
    $kategoriPromptlari = @{
        "CPU_Metrics" = "Analyze CPU usage, including utilization trends, bottlenecks, and potential overcommitment issues."
        "Memory_Metrics" = "Evaluate memory usage, including active memory, consumed memory, and swap usage. Identify memory leaks and insufficient memory conditions."
        "Disk_Metrics" = "Analyze disk I/O performance, including read/write latency and throughput. Assess disk bottlenecks and performance issues."
        "Network_Metrics" = "Analyze network traffic, packet loss, and network utilization. Evaluate network performance issues and anomalies."
        "Performance_Metrics" = "Assess system uptime, power consumption, and resource limiting conditions. Provide an overall evaluation of system health."
    }
    
    $aiPrompt = @"
        $($kategoriPromptlari[$kategoriAdi])

        $kategoriAdi datas to analyze:
        $jsonPayload

        Below is long-term resource utilization data for a virtual machine (VM).
        The data has been collected via the vROps API at 1-hour intervals.
        Please analyze the data according to the following steps:

        General Trend and Utilization Analysis:
            Identify and interpret usage trends (e.g., increases, decreases, fluctuations).
            Evaluate how resource utilization intensity has changed over time.

        Anomaly Detection:
            Detect any sudden spikes, drops, or unusual patterns in usage.
            Indicate the specific time periods where anomalies are concentrated.

        Capacity and Risk Analysis:
            Identify periods of excessive or insufficient resource usage.
            Based on long-term usage statistics, assess whether the current resource allocation is sufficient.
            Would you recommend reclaiming any underutilized resources?

        Recommendations:
            Provide suggestions to increase, decrease, or reconfigure the current resource allocation.
            If necessary, outline proactive measures or actions that should be taken.


        Please summarize all findings in a single, detailed paragraph, including technical insights and justifications for each conclusion.
        Respond in turkish please. But dont use turkish characters.
"@

    Write-Host "=== $kategoriAdi Analizi ===" -ForegroundColor Cyan
    $body = @{
        messages = @(
            @{
                role = "system"
                content =   "You are a cloud‑resources optimization assistant."           
            },
            @{
                role = "user"
                content = $aiPrompt
            }
        )
        temperature = 0.7
        max_tokens = 4000
    } | ConvertTo-Json -Depth 10 -Compress

    # HTTP başlıkları
    $headers = @{
        "Content-Type" = "application/json"
        "api-key" = $apiKey
    }

    # API'ye gönder
    try {
        $response = Invoke-RestMethod -Uri $endpoint -Method Post -Headers $headers -Body $body
        $answer = $response.choices[0].message.content
        return $answer
    } catch {
        return "Hata oluştu: $($_.Exception.Message)"
    }

}

# Her kategori için ayrı analiz yap
$analizSonuclari = @{}

foreach ($vm in $vmMetrikleri.PSObject.Properties) {
    $vmAdi = $vm.Name
    $kategorilereAyrilmisMetrikler=$vm.Value
    $analizSonuclari[$vmAdi] = @{}
    foreach ($kategori in $kategorilereAyrilmisMetrikler.PSObject.Properties) {
        if ($kategorilereAyrilmisMetrikler.($kategori.Name).Count -gt 0) {
            $kategoriAdi = $kategori.Name
            $metrikler = $kategori.Value
            Write-Host "Processing $kategoriAdi..." -ForegroundColor Magenta
            $analizSonuclari[$vmAdi][$kategoriAdi] = Send-ToAIAnalysis -kategoriAdi $kategoriAdi -metrikler $metrikler
        } else {
            Write-Host "$kategori.Name için veri bulunamadı." -ForegroundColor Red
        }
    }
}

$jsonOutput = $analizSonuclari | ConvertTo-Json -Depth 5
$outputFilePath = "C:\Users\AliCanda\Documents\calismalar\VMsMetricsOutput.json"
Set-Content -Path $outputFilePath -Value $jsonOutput -Encoding UTF8
Write-Host "Metrics saved to $outputFilePath"

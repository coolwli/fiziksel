private void SendUsageDataToClient(Dictionary<string, double[]> metricsData, DateTime[] timestamps)
{
    var scriptBuilder = new StringBuilder();

    // Format timestamps as ISO 8601 strings
    var formattedTimestamps = timestamps.Select(t => $"\"{t:yyyy-MM-ddTHH:mm:ss}\"");
    scriptBuilder.AppendLine($"let dates = [{string.Join(",", formattedTimestamps)}];");

    // Create an object for metricsData
    var metricsDataJson = JsonConvert.SerializeObject(metricsData);
    scriptBuilder.AppendLine($"let metricsData = {metricsDataJson};");

    ClientScript.RegisterStartupScript(this.GetType(), "usageDataScript", scriptBuilder.ToString(), true);
}

<script>
    const createChart = (ctx, data, dates, label, borderColor) => {
        const min = Math.min(...data.map(d => d.y));
        const max = Math.max(...data.map(d => d.y));

        const minIndex = data.findIndex(d => d.y === min);
        const maxIndex = data.findIndex(d => d.y === max);

        const backgroundColor = borderColor.replace('1)', '0.2)'); // Adjusted for a consistent color

        const config = {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: `Minimum: ${min.toFixed(2)}%`,
                        data: [{ x: dates[minIndex], y: min }],
                        borderColor: 'red',
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 4,
                        pointBackgroundColor: 'red'
                    },
                    {
                        label: `Maximum: ${max.toFixed(2)}%`,
                        data: [{ x: dates[maxIndex], y: max }],
                        borderColor: 'black',
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 4,
                        pointBackgroundColor: 'black'
                    },
                    {
                        label: label,
                        data: data,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 1,
                        tension: 0.1 // Slightly adjusted for a smoother line
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: `${label} Usage`
                    },
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        backgroundColor: '#333',
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                },
                interaction: {
                    intersect: false
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        },
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        grid: {
                            color: '#e0e0e0'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Value'
                        },
                        suggestedMin: Math.max(0, min - 10),
                        suggestedMax: max + 10,
                        grid: {
                            color: '#e0e0e0'
                        }
                    }
                }
            }
        };

        return new Chart(ctx, config);
    };

    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    const diskCtx = document.getElementById('diskChart').getContext('2d');

    let cpuChart;
    let memoryChart;
    let diskChart;

    const updateDiskPanels = (diskLabels, diskDataMap) => {
        const container = document.getElementById('diskPanelContainer');
        container.innerHTML = '';

        diskLabels.forEach(label => {
            const panel = document.createElement('div');
            panel.className = 'panel';
            panel.setAttribute('data-disk', label);

            const averageUsage = calculateAverage(diskDataMap[label]);

            panel.innerHTML = 
                `Disk ${label} <span class="panel-value">${averageUsage}%</span>`;

            panel.addEventListener('click', () => handlePanelClick(label));
            container.appendChild(panel);
        });
    };

    const updateDiskChart = (diskLabel, diskDataMap) => {
        const dates = [];
        const diskData = diskDataMap[diskLabel];

        if (!diskData) return;

        diskData.forEach(d => dates.push(d.x));

        if (diskChart) diskChart.destroy();

        diskChart = createChart(diskCtx, diskData, dates, `Disk ${diskLabel} Usage`, 'rgba(255, 159, 64, 1)');
    };

    const handlePanelClick = (diskLabel) => {
        document.querySelectorAll('.panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.querySelector(`.panel[data-disk="${diskLabel}"]`).classList.add('active');
        updateDiskChart(diskLabel, metricsData);
    };

    const calculateAverage = (data) => {
        const sum = data.reduce((acc, d) => acc + d.y, 0);
        return (sum / data.length).toFixed(2); // Average value rounded to 2 decimal places
    };

    const fetchData = () => {
        const range = parseInt(document.getElementById('timeRange').value);
        const numPoints = range;
        const dates = [];

        if (cpuChart) cpuChart.destroy();
        if (memoryChart) memoryChart.destroy();
        if (diskChart) diskChart.destroy();

        // Create CPU and Memory charts
        cpuChart = createChart(cpuCtx, metricsData['cpu'], dates, 'CPU Usage', 'rgba(75, 192, 192, 1)');
        memoryChart = createChart(memoryCtx, metricsData['memory'], dates, 'Memory Usage', 'rgba(153, 102, 255, 1)');

        // Update disk panels and chart
        const diskLabels = Object.keys(metricsData).filter(key => key.startsWith('disk'));
        updateDiskPanels(diskLabels, metricsData);
        if (diskLabels.length > 0) {
            updateDiskChart(diskLabels[0], metricsData);
        }
    };

    // Initial fetch on page load
    fetchData();
</script>

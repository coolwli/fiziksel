# SMTP Ayarları
$SMTPHost = "smtpappv1.fw.garanti.com.tr"
$SMTPPort = 25
$from = "automation@CloudUnited <noreply@garantibbva.com.tr>"
$to = "alicanda1@garantibbva.com.tr"
$subject = "faz-4"

$excelApp = New-Object -ComObject Excel.Application
# Excel dosyasını oku
$excelFile = "F:\Ali\powershell\data.xlsx"



#################### böyle yaz eskisini değiştir
$excelData = Import-Excel -Path $excelFile
$excelApp.Visible = $false###############

# Son sütunu dinamik olarak al (Sahibi Sütunu)
$lastColumnIndex = $excelData[0].PSObject.Properties.Count - 1
$ownerColumnName = $excelData[0].PSObject.Properties[$lastColumnIndex].Name

# Grupları ayır ve her grup için email gönder
$groupedData = $excelData | Group-Object -Property $ownerColumnName

foreach ($group in $groupedData) {
    $groupName = $group.Name
    $groupRows = $group.Group

    # HTML Tablosunu oluştur
    $htmlTable = $groupRows | ConvertTo-Html -As Table -PreContent "<h4>ODM Replike olan DataStore'larda düzensiz VM'ler bulunmuştur:</h4>"

    # E-posta içeriği oluştur
    $body = @"
<html>
<head>
    <style>
        body {
            font-family: Verdana, Geneva, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }
        h4 {
            color: #333;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f4f4f4;
            color: #333;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    $htmlTable
</body>
</html>
"@

    # Email gönder
    Send-Email -subject "$subject - $groupName" -body $body -to $groupName
}

# Send-Email Fonksiyonu
function Send-Email {
    param(
        [string]$subject,
        [string]$body,
        [string]$to
    )

    $SMTPClient = New-Object Net.Mail.SmtpClient($SMTPHost, $SMTPPort)
    $message = New-Object Net.Mail.MailMessage($from, $to, $subject, $body)
    $message.IsBodyHtml = $true

    # Email gönderimi
    $SMTPClient.Send($message)
    $message.Dispose()
    $SMTPClient.Dispose()
}

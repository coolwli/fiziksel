param (
    [int]$start = 0
)

function Get-VMInfo($vm, $vcenter) {
    # Disk Bilgileri
    $diskInfo = @()
    $totalStorage = 0
    foreach ($disk in $vm | Get-HardDisk) {
        $diskInfo += [PSCustomObject]@{
            Name        = $disk.Name
            Format      = $disk.StorageFormat
            CapacityGB  = $disk.CapacityGB
            DataStore   = ($disk.Filename -split ' ')[0].Trim('[', ']')
        }
        $totalStorage += $disk.CapacityGB
    }

    # Disk Bilgilerini birleştirme
    $diskNames = ($diskInfo | ForEach-Object { $_.Name }) -join "~"
    $diskFormats = ($diskInfo | ForEach-Object { $_.Format }) -join "~"
    $diskCapacities = ($diskInfo | ForEach-Object { $_.CapacityGB }) -join "~"
    $diskDataStores = ($diskInfo | ForEach-Object { $_.DataStore }) -join "~"

    # IP Adresi Alma
    $VMIp = $null
    $ips = $vm.Guest.IPAddress -split ' '
    foreach ($ip in $ips) {
        if ($ip -match '^\d{1,3}(\.\d{1,3}){3}$') {  # IPv4 formatını kontrol eder
            $VMIp = $ip
            break
        }
    }

    # Tag Bilgisi Alma
    $tags = @()
    if ($vcenter -eq "ptekvcs01") {
        $tags = ($vm | Get-TagAssignment).Tag
    }
    $tagsString = $tags -join "~"

    # Sonuçları döndürme
    return @{
        VMName          = $vm.Name
        VMIP            = $VMIp
        vCenter         = $vcenter
        VMPowerState    = $vm.PowerState
        VMGuestOS       = $vm.Guest.OSFullName
        VMNotes         = $($vm.Notes -replace "[(),'\n]", " " -replace ";", ".")
        VMDiskName      = $diskNames
        VMDiskTotalSize = $diskCapacities
        VMDiskStorageFormat = $diskFormats
        VMDiskDataStore = $diskDataStores
        VMNumCPU        = $vm.NumCpu
        VMMemoryCapacity = $vm.MemoryGB
        VMHost          = $vm.VMHost.Parent.Name -replace '#', ''
        VMCluster       = $vm.VMHost.Parent.ParentFolder.Parent.Name
        VMDataCenter    = $vm.VMHost.Name
        LastUpdate      = (Get-Date -Format "yyyy-MM-dd HH:mm")
        VMTotalStorage  = $totalStorage
        VMUsedStorage   = "{0:F2}" -f [decimal]$vm.UsedSpaceGB
        VMTags          = $tagsString
        PersistentId    = $vm.PersistentId
        CreateDate      = ($vm.CreateDate -split ' ')[0]
    }
}

# Veritabanı Bağlantısı
$conn = New-Object System.Data.SqlClient.SqlConnection "Data Source=TEKSCR1\SQLEXPRESS;Database=CloudUnited;Integrated Security=True"
$encrypted = Get-Content F:\Serhat\servicejobs_password.txt | ConvertTo-SecureString
$servicejobscred = New-Object System.Management.Automation.PsCredential("GARANTI\servicejobs", $encrypted)

$conn.Open()

# vCenter Sunucuları
$vcenters = ("apgaraavcs801", "ptekvcs01", "apgartstvcs201", "ptekvcsd01", "apgartksvcs201", "apgartksvcs801")

foreach ($vcenter in $vcenters) {
    for ($i = 0; $i -lt 2; $i++) {
        # vCenter'a Bağlanma
        Connect-VIServer -Server $vcenter -Credential $servicejobscred
        $vms = Get-VM | Select-Object -Skip (($start * 1000) + ($i * 500)) -First 500
        $vmInfoArray = @()

        # VM Bilgilerini Alma
        foreach ($vm in $vms) {
            $vmInfo = Get-VMInfo $vm $vcenter
            $vmInfoArray += $vmInfo
        }

        # vCenter Bağlantısını Kesme
        Disconnect-VIServer -Server $vcenter -Confirm:$false
        
        # SQL Insert Sorgusunu Hazırlama
        $values = $vmInfoArray | ForEach-Object {
            "('$($_.VMName)', '$($_.VMIP)', '$($_.vCenter)', '$($_.VMPowerState)', '$($_.VMGuestOS)', '$($_.VMNotes)', 
            '$($_.VMDiskName)', '$($_.VMDiskTotalSize)', '$($_.VMDiskStorageFormat)', '$($_.VMDiskDataStore)', 
            '$($_.VMNumCPU)', '$($_.VMMemoryCapacity)', '$($_.VMHost)', '$($_.VMCluster)', '$($_.VMDataCenter)', 
            '$($_.LastUpdate)', '$($_.VMTotalStorage)', '$($_.VMUsedStorage)', '$($_.VMTags)', '$($_.PersistentId)', 
            '$($_.CreateDate)')"
        }

        # Veritabanına Veri Ekleme
        if ($values.Count -gt 0) {
            $sql = "INSERT INTO vminfoVMs (VMName, VMIP, vCenter, VMPowerState, VMGuestOS, VMNotes, VMDiskName, VMDiskTotalSize, 
                VMDiskStorageFormat, VMDiskDataStore, VMNumCPU, VMMemoryCapacity, VMHost, VMCluster, VMDataCenter, LastUpdate, 
                VMTotalStorage, VMUsedStorage, VMTags, PersistentId, CreateDate) VALUES " + ($values -join ",")
            $command = $conn.CreateCommand()
            $command.CommandText = $sql
            $command.ExecuteNonQuery()
        }
    }
}

# Veritabanı Bağlantısını Kapatma
$conn.Close()

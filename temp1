
function Get-VmData {
    param(
        [string]$Server,
        [string]$Token
    )
    
    try {
        Write-Host "Fetching VM data..." -ForegroundColor Yellow
        
        $headers = @{
            'Authorization' = "vRealizeOpsToken $Token"
        }
        
        $response = Invoke-RestMethod -Uri $VmViewUrl -Method GET -Headers $headers -TimeoutSec $TimeoutSeconds
        
        $vmList = @()
        
        foreach ($view in $response.PSObject.Properties) {
            foreach ($element in $view.Value.PSObject.Properties) {
                if ($element.Name -eq "rows") {
                    foreach ($rowGroup in $element.Value) {
                        foreach ($row in $rowGroup.PSObject.Properties) {
                            $vmData = $row.Value
                            
                            $vm = [PSCustomObject]@{
                                Name = if ($vmData.objId) { $vmData.objId.ToString() } else { "" }
                                Host = if ($vmData."1") { $vmData."1".ToString() } else { "" }
                                Cluster = if ($vmData."2") { $vmData."2".ToString() } else { "" }
                                Cpu = if ($vmData."3") { [decimal]($vmData."3".ToString()) } else { 0 }
                            }
                            
                            $vmList += $vm
                        }
                    }
                }
            }
        }
        
        Write-Host "Retrieved $($vmList.Count) VMs" -ForegroundColor Green
        return $vmList
    }
    catch {
        Write-Error "Failed to fetch VM data: $($_.Exception.Message)"
        return @()
    }
}

# Function to fetch Host data
function Get-HostData {
    param(
        [string]$Server,
        [string]$Token
    )
    
    try {
        Write-Host "Fetching Host data..." -ForegroundColor Yellow
        
        $headers = @{
            'Authorization' = "vRealizeOpsToken $Token"
        }
        
        $response = Invoke-RestMethod -Uri $HostViewUrl -Method GET -Headers $headers -TimeoutSec $TimeoutSeconds
        
        $hostMapping = @{}
        
        foreach ($view in $response.PSObject.Properties) {
            foreach ($element in $view.Value.PSObject.Properties) {
                if ($element.Name -eq "rows") {
                    foreach ($rowGroup in $element.Value) {
                        foreach ($row in $rowGroup.PSObject.Properties) {
                            $hostData = $row.Value
                            
                            $hostName = if ($hostData.objId) { $hostData.objId.ToString() } else { "" }
                            $hostCpu = if ($hostData."1") { [decimal]($hostData."1".ToString()) } else { 0 }
                            
                            if ($hostName -and $hostName -ne "") {
                                $hostMapping[$hostName] = $hostCpu
                            }
                        }
                    }
                }
            }
        }
        
        Write-Host "Retrieved $($hostMapping.Count) Hosts" -ForegroundColor Green
        return $hostMapping
    }
    catch {
        Write-Error "Failed to fetch Host data: $($_.Exception.Message)"
        return @{}
    }
}

# Function to enrich VM data with host information
function Merge-VmWithHostData {
    param(
        [array]$VmData,
        [hashtable]$HostData
    )
    
    Write-Host "Merging VM and Host data..." -ForegroundColor Yellow
    
    $enrichedData = @()
    
    foreach ($vm in $VmData) {
        $enrichedVm = [PSCustomObject]@{
            Name = $vm.Name
            Host = $vm.Host
            Cluster = $vm.Cluster
            Cpu = $vm.Cpu
            HostCpu = $null
            Percentage = $null
        }
        
        if ($vm.Host -and $HostData.ContainsKey($vm.Host)) {
            $hostCpu = $HostData[$vm.Host]
            $enrichedVm.HostCpu = $hostCpu
            
            if ($hostCpu -gt 0) {
                $enrichedVm.Percentage = [Math]::Round(($vm.Cpu / $hostCpu) * 100, 2)
            } else {
                $enrichedVm.Percentage = 0
            }
        }
        
        $enrichedData += $enrichedVm
    }
    
    Write-Host "Merged data for $($enrichedData.Count) VMs" -ForegroundColor Green
    return $enrichedData
}

# Function to export data
function Export-Data {
    param(
        [array]$Data,
        [string]$Path
    )
    
    try {
        # Export as JSON
        $jsonData = $Data | ConvertTo-Json -Depth 3
        $jsonData | Out-File -FilePath $Path -Encoding UTF8
        Write-Host "Data exported to: $Path" -ForegroundColor Green
        
        # Also create a CSV version
        $csvPath = $Path -replace '\.json$', '.csv'
        $Data | Export-Csv -Path $csvPath -NoTypeInformation -Encoding UTF8
        Write-Host "CSV exported to: $csvPath" -ForegroundColor Green
        
        # Display summary
        Write-Host "`n=== Data Summary ===" -ForegroundColor Cyan
        Write-Host "Total VMs: $($Data.Count)"
        Write-Host "VMs with Host CPU data: $(($Data | Where-Object { $_.HostCpu -ne $null }).Count)"
        Write-Host "Average VM CPU: $([Math]::Round(($Data | Measure-Object -Property Cpu -Average).Average, 2))"
        Write-Host "Average Host CPU: $([Math]::Round(($Data | Where-Object { $_.HostCpu -ne $null } | Measure-Object -Property HostCpu -Average).Average, 2))"
        
        return $true
    }
    catch {
        Write-Error "Failed to export data: $($_.Exception.Message)"
        return $false
    }
}

# Main execution
Write-Host "=== vRealizeOps VM-Host Data Fetcher ===" -ForegroundColor Cyan
Write-Host "Server: $VropsServer" -ForegroundColor White

try {
    # Step 1: Acquire token
    $token = Get-VropsToken -Server $VropsServer -Username $Username -Password $Password
    if (-not $token) {
        throw "Failed to acquire authentication token"
    }
    
    # Step 2: Fetch VM data
    $vmData = Get-VmData -Server $VropsServer -Token $token
    if ($vmData.Count -eq 0) {
        throw "No VM data retrieved"
    }
    
    # Step 3: Fetch Host data
    $hostData = Get-HostData -Server $VropsServer -Token $token
    if ($hostData.Count -eq 0) {
        Write-Warning "No Host data retrieved - continuing with VM data only"
    }
    
    # Step 4: Merge data
    $enrichedData = Merge-VmWithHostData -VmData $vmData -HostData $hostData
    
    # Step 5: Export data
    $success = Export-Data -Data $enrichedData -Path $OutputPath
    
    if ($success) {
        Write-Host "`n=== Operation Completed Successfully ===" -ForegroundColor Green
        
        # Return the data object for further processing if needed
        return $enrichedData
    } else {
        throw "Failed to export data"
    }
}
catch {
    Write-Host "`n=== Operation Failed ===" -ForegroundColor Red
    Write-Error $_.Exception.Message
    exit 1
}


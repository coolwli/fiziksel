$apiKey = "8G7kTdsDJLqEVLuGFGHgBC2BxFx4AsQpkKMVQvxrrKd2R0Fc83GNJQQJ99BDACfhMk5XJ3w3AAABACOGVRgB" # Azure OpenAI API anahtarınızı buraya ekleyin
$endpoint = "https://openai-swe-bulutaltyapi.openai.azure.com/openai/deployments/gpt-4.1-bulutaltyapi/chat/completions?api-version=2025-01-01-preview" # Endpoint URL'nizi buraya ekleyin

# Input/Output Configuration
$csvFilePath = "C:\Users\AliCanda\Documents\calismalar\reclaim_api_test.csv"
$csvOutputPath = "C:\Users\AliCanda\Documents\calismalar\reclaim_api_output.csv"

$batchSize = 50

# Read CSV data
$data = Import-Csv -Path $csvFilePath
Write-Host "Found $($data.Count) records to process" -ForegroundColor Green


$columns=$data[0].psobject.Properties.Name[0..8]
# Initialize results array
$allResults = @()
 
 
for ($i = 0; $i -lt $data.Count; $i += $batchSize) {
    $endIndex = if (($i + $batchSize - 1) -lt $data.Count) { $i + $batchSize - 1 } else { $data.Count - 1 }
    $batch = $data[$i..$endIndex]
    
    $selectedBatch = $batch | Select-Object $columns
    $batchJson = $selectedBatch | ConvertTo-Json -Depth 10

    
    # Prompt'u oluştur
    $prompt = @"
        You are a senior VMware infrastructure architect with expertise in virtualization resource optimization. Your task is to analyze virtual machine performance metrics and provide data-driven recommendations for CPU and memory rightsizing.

        ## Analysis Context
        - **Time Period**: 3-month historical performance data
        - **Objective**: Identify overprovisioned resources while maintaining performance SLA
        - **Risk Tolerance**: Conservative approach - prioritize stability over aggressive savings

        ## Input Data Structure
        Each VM record contains:
        - `VM_ID`: Virtual machine identifier
        - `Current_CPU`: Currently allocated vCPUs (integer)
        - `CPU_Usage`: Historical CPU utilization metrics
          - `avg`: Average CPU usage over 3 months (%)
          - `p95`: 95th percentile CPU usage (%)
          - `p99`: 99th percentile CPU usage (%)
        - `Current_Memory`: Currently allocated memory in GB (integer)
        - `Memory_Usage`: Historical memory utilization metrics
          - `avg`: Average memory consumption (%)
          - `p95`: 95th percentile memory usage (%)
          - `p99`: 99th percentile memory usage

        **Input JSON Data:**
        $batchJson

        ## Reclaim Score Methodology

        Calculate a **Reclaim Score (0-100)** for both CPU and memory where higher scores indicate greater overprovisioning and reclaim potential - develop a professional scoring algorithm based on the utilization patterns in the historical data.

        ## Optimization Guidelines

        ### CPU Rightsizing Rules:
        1. **Minimum Configuration**: Never suggest less than 2 vCPUs
        2. **Safety Margin**: Maintain 50% minimum of current allocation
        3. **Even Numbers**: Always suggest even vCPU counts

        ### Memory Rightsizing Rules:
        1. **Minimum Configuration**: Never suggest less than 4 GB
        2. **Safety Margin**: Maintain 50% minimum of current allocation
        3. **Even Numbers**: Always suggest even GB amounts

        ## Required Output Format

        Return ONLY a valid JSON array for my script with the following structure for each VM:

        [
          {
            "VM ID": "hostname",
            "Current CPU": integer,
            "Reclaim Score CPU": integer (0-100),
            "Suggested CPU": integer (even, ≥2, ≥50% of current),
            "Current Memory": integer,
            "Reclaim Score Memory": integer (0-100),
            "Suggested Memory": integer (even, ≥4, ≥50% of current)
          }
        ]   
"@
    
    # JSON body oluştur
    $body = @{
        messages = @(
            @{
                role = "system"
                content =   "You are a cloud‑resources optimization assistant. " +
                            "Your job is to analyze VM CPU & memory usage metrics, " +
                            "compute a light‑touch reclaim score, and recommend new vCPU+RAM pairs. " +
                            "Be precise, concise, and follow the rules strictly."
            },
            @{
                role = "user"
                content = $prompt
            }
        )
        temperature = 0.7
    } | ConvertTo-Json -Depth 10

    # HTTP başlıkları
    $headers = @{
        "Content-Type" = "application/json"
        "api-key" = $apiKey
    }

    # API'ye gönder
    try {
        $response = Invoke-RestMethod -Uri $endpoint -Method Post -Headers $headers -Body $body
        $answer = $response.choices[0].message.content
        
        # çıktıya diğer sütunları ekle
        $batchHash = @{}
        foreach ($row in $batch) {
            $batchHash[$row.'ID'] = $row
        }
        $answerjson = $answer | ConvertFrom-Json
        foreach ($apiResult in $answerjson) {
            $vmName = $apiResult.'VM ID'
            $original = $batchHash[$vmName]

            # Ek sütunları ekle(web sayfası için)
            $apiResult | Add-Member -NotePropertyName "Parent vCenter" -NotePropertyValue $original.'Parent vCenter'
            $apiResult | Add-Member -NotePropertyName "Name" -NotePropertyValue $original.'Name'

            $allResults += $apiResult
        }
        Write-Host "Batch $($i / $batchSize + 1) işlendi." 
    } catch {
        Write-Host "Hata oluştu: $($_.Exception.Message)"
    }
}

# Sonuçları tek bir CSV dosyasında birleştir
$mergedResults = @()
foreach ($result in $allResults) {
    $obj = New-Object PSObject
    $obj | Add-Member -NotePropertyName "VM Name" -NotePropertyValue $result.'Name'
    $obj | Add-Member -NotePropertyName "Current CPU" -NotePropertyValue $result.'Current CPU'
    $obj | Add-Member -NotePropertyName "Reclaim Score CPU" -NotePropertyValue $result.'Reclaim Score CPU'
    $obj | Add-Member -NotePropertyName "Suggested CPU" -NotePropertyValue $result.'Suggested CPU'
    $obj | Add-Member -NotePropertyName "Current Memory" -NotePropertyValue $result.'Current Memory'
    $obj | Add-Member -NotePropertyName "Reclaim Score Memory" -NotePropertyValue $result.'Reclaim Score Memory'
    $obj | Add-Member -NotePropertyName "Suggested Memory" -NotePropertyValue $result.'Suggested Memory'
    $obj | Add-Member -NotePropertyName "Summary|Parent vCenter" -NotePropertyValue $result.'Summary|Parent vCenter'
    $obj | Add-Member -NotePropertyName "Summary|UUID" -NotePropertyValue $result.'ID'
    $mergedResults += $obj
}


# İlk satırı (başlık) atla ve CSV'ye yaz
$mergedResults | Export-Csv -Path $csvOutputPath -NoTypeInformation -Encoding UTF8
Write-Host "Sonuçlar $csvOutputPath dosyasına kaydedildi."

CREATE TABLE sunucu_cpu_istatistikleri (
    name NVARCHAR(255) NOT NULL,
    vcenter NVARCHAR(255) NOT NULL,
    cpu_core NVARCHAR(50),
    intel_count INT NOT NULL,
    amd_count INT NOT NULL,
    tarih DATE NOT NULL
);


add-type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint srvPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
[System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy

$token = (F:\Ali\powershell\getVropsToken.ps1 -tokenType "pendik")

if ($token -eq $null) {
    return "Token is null"
}

$headers = @{
    "Content-Type"  = "application/json"
    "Authorization" = "vRealizeOpsToken $token"
}

$reportsUrl = "view link"

$reportsResponse = Invoke-RestMethod -Method Get -Uri $reportsUrl -Headers $headers -ContentType "application/json"

$nameMap = @{}
$tarih = Get-Date -Format "yyyy-MM-dd"

foreach ($row in $reportsResponse.viewsData.rows) {
    $name      = $row.cells[2]
    $cpuModel  = $row.cells[4]
    $vcenter   = $row.cells[1]
    $cpuCore   = $row.cells[3]

    if (-not $nameMap.ContainsKey($name)) {
        $nameMap[$name] = [PSCustomObject]@{
            name       = $name
            vcenter    = $vcenter
            cpu_core   = $cpuCore
            intelCount = 0
            amdCount   = 0
            tarih      = $tarih
        }
    }

    if ($cpuModel -imatch "intel") {
        $nameMap[$name].intelCount++
    }
    elseif ($cpuModel -imatch "amd") {
        $nameMap[$name].amdCount++
    }
}

$connectionString = "Server=YOUR_SQL_SERVER;Database=YOUR_DATABASE;Integrated Security=True"
$sqlConnection = New-Object System.Data.SqlClient.SqlConnection
$sqlConnection.ConnectionString = $connectionString
$sqlConnection.Open()

foreach ($item in $nameMap.Values) {
    $sqlCommand = $sqlConnection.CreateCommand()
    $sqlCommand.CommandText = @"
INSERT INTO sunucu_cpu_istatistikleri (name, vcenter, cpu_core, intel_count, amd_count, tarih)
VALUES (@name, @vcenter, @cpu_core, @intelCount, @amdCount, @tarih)
"@
    $sqlCommand.Parameters.AddWithValue("@name", $item.name) | Out-Null
    $sqlCommand.Parameters.AddWithValue("@vcenter", $item.vcenter) | Out-Null
    $sqlCommand.Parameters.AddWithValue("@cpu_core", $item.cpu_core) | Out-Null
    $sqlCommand.Parameters.AddWithValue("@intelCount", $item.intelCount) | Out-Null
    $sqlCommand.Parameters.AddWithValue("@amdCount", $item.amdCount) | Out-Null
    $sqlCommand.Parameters.AddWithValue("@tarih", $item.tarih) | Out-Null

    $sqlCommand.ExecuteNonQuery()
}

$sqlConnection.Close()

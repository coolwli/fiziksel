param(
    [int]$start = 0
)

$vcenters = ("ptekvcs01","apgaraavcs801","apgartstvcs201","ptekvcsd01")

foreach ($vcenter in $vcenters) {
    Connect-VIServer -Server $vcenter 

    $vms = Get-VM

    foreach ($vm in $vms) {
        $vmNotes = (((($vm.Notes) -replace "'"," ") -replace ";",".") -replace ","," ") -replace "\n"," "
        $vmName = $vm.Name
        $vmOwner = $vm.CustomFields.Value[5]
        $vmPowerState = $vm.PowerState
        $vmGuestOS = $vm.Guest.OSFullName
        $vmCreatedDate = if ($vm.CreateDate -eq "01/01/1970 00:00:00") { "NULL" } else { ($vm.CreateDate -split ' ')[0] }
        $vmCoresPerSocket = $vm.CoresPerSocket
        $vmNumCPU = $vm.NumCpu 
        $vmMemory = $vm.MemoryGB
        $vmCluster = $vm.VMHost.Parent.Name -replace '#',''
        $vmDataCenter = $vm.VMHost.Parent.ParentFolder.Parent.Name
        $vmHost = $vm.VMHost.Name
        $VMHostModel = $vm.VMHost.Model
        $lastWriteTime = Get-Date -Format "yyyy-MM-dd HH:mm"

        $AdapterName = ""
        $NetworkName = ""
        $AdapterType = ""
        $AdapterMACAddress = ""
        foreach ($adapter in $vm | Get-NetworkAdapter) {
            $AdapterName += "$($adapter.Name)~" 
            $NetworkName += "$($adapter.NetworkName)~"
            $AdapterMACAddress += "$($adapter.MacAddress)~"
            $AdapterType += "$($adapter.Type)~"
        }

        $diskName = ""
        $diskFormat = ""
        $diskCapacity = ""
        $diskDS = ""
        $TotalCapacity = 0
        $disks = $vm | Get-HardDisk
        foreach ($disk in $disks) {
            $diskName += "$($disk.Name)~"
            $diskFormat += "$($disk.StorageFormat)~"
            $diskCapacity += "$($disk.CapacityGB)~"
            $diskDS += "$(($disk.Filename -split ' ')[0].Trim('[',']'))~"
            $TotalCapacity += $disk.CapacityGB
        }

        if ($vmPowerState -eq "PoweredOn") {
            $CPUAverageUsage = [Math]::Round(((Get-Stat -Entity $vm -Stat cpu.usage.average -Start (Get-Date).AddDays(-7) -IntervalMins 1 | Measure-Object Value -Average).Average), 2)
            $DiskAverageUsage = [Math]::Round(((Get-Stat -Entity $vm -Stat disk.usage.average -Start (Get-Date).AddDays(-7) -IntervalMins 1 | Measure-Object Value -Average).Average), 2)
            $NetworkAverageUsage = [Math]::Round(((Get-Stat -Entity $vm -Stat net.usage.average -Start (Get-Date).AddDays(-7) -IntervalMins 1 | Measure-Object Value -Average).Average), 2)
            $MemoryAverageUsage = "{0:P}" -f ($vm.ExtensionData.Summary.Quickstats.GuestMemoryUsage / $vm.MemoryMB) -replace '%',''
        }
        else {
            $CPUAverageUsage = 0
            $MemoryAverageUsage = 0
            $NetworkAverageUsage = 0
            $DiskAverageUsage = 0
        }

        $EventLogs = Get-VIEvent -Entity $vm -Start (Get-Date).AddDays(-3)
        $eventDate = ""
        $eventMessage = ""
        foreach ($EventLog in $EventLogs) {
            $eventDate += "$($EventLog.CreatedTime)~"
            $eventMessage += "$((($EventLog.FullFormattedMessage) -replace "'"," ") -replace ","," ")~"
        }

        $sql = @"
            INSERT INTO VMInfos2 (VMName, VMOwner, vCenter, VMPowerState, VMGuestOS, VMNotes, VMAverageCPUUsage, VMAverageMemoryUsage, VMAverageNetworkUsage, VMAverageDiskUsage, VMNetworkAdapterName, VMNetworkName, VMNetworkCardType, VMNetworkAdapterMacAddress, VMDiskName, VMDiskTotalSize, VMDiskStorageFormat, VMDiskDataStore, VMCreatedDate, VMNumCPU, VMCoresPerSocket, VMMemoryCapacity, VMCluster, VMDataCenter, VMHost, LastWriteTime, VMTotalDisk, VMHostModel, VMEventDates, VMEventMessages) 
            VALUES
            (@VMName, @VMOwner, @vcenter, @VMPowerState, @VMGuestOS, @vmNotes, @CPUAverageUsage, @MemoryAverageUsage, @NetworkAverageUsage, @DiskAverageUsage, @AdapterName, @NetworkName, @AdapterType, @AdapterMACAddress, @diskName, @TotalCapacity, @diskFormat, @diskDS, @vmCreatedDate, @vmNumCPU, @vmCoresPerSocket, @vmMemory, @vmCluster, @vmDataCenter, @vmHost, @lastWriteTime, @TotalCapacity, @VMHostModel, @eventDate, @eventMessage)
"@

        $command = $conn.CreateCommand()
        $command.CommandText = $sql
        $command.Parameters.AddWithValue("@VMName", $vmName)
        $command.Parameters.AddWithValue("@VMOwner", $vmOwner)
        $command.Parameters.AddWithValue("@vcenter", $vcenter)
        $command.Parameters.AddWithValue("@VMPowerState", $vmPowerState)
        $command.Parameters.AddWithValue("@VMGuestOS", $vmGuestOS)
        $command.Parameters.AddWithValue("@vmNotes", $vmNotes)
        $command.Parameters.AddWithValue("@CPUAverageUsage", $CPUAverageUsage)
        $command.Parameters.AddWithValue("@MemoryAverageUsage", $MemoryAverageUsage)
        $command.Parameters.AddWithValue("@NetworkAverageUsage", $NetworkAverageUsage)
        $command.Parameters.AddWithValue("@DiskAverageUsage", $DiskAverageUsage)
        $command.Parameters.AddWithValue("@AdapterName", $AdapterName)
        $command.Parameters.AddWithValue("@NetworkName", $NetworkName)
        $command.Parameters.AddWithValue("@AdapterType", $AdapterType)
        $command.Parameters.AddWithValue("@AdapterMACAddress", $AdapterMACAddress)
        $command.Parameters.AddWithValue("@diskName", $diskName)
        $command.Parameters.AddWithValue("@TotalCapacity", $TotalCapacity)
        $command.Parameters.AddWithValue("@diskFormat", $diskFormat)
        $command.Parameters.AddWithValue("@diskDS", $diskDS)
        $command.Parameters.AddWithValue("@vmCreatedDate", $vmCreatedDate)
        $command.Parameters.AddWithValue("@vmNumCPU", $vmNumCPU)
        $command.Parameters.AddWithValue("@vmCoresPerSocket", $vmCoresPerSocket)
        $command.Parameters.AddWithValue("@vmHost", $vmMemory)
        $command.Parameters.AddWithValue("@vmCluster", $vmCluster)
        $command.Parameters.AddWithValue("@vmDataCenter", $vmDataCenter)
        $command.Parameters.AddWithValue("@vmHost", $vmHost)
        $command.Parameters.AddWithValue("@lastWriteTime", $lastWriteTime)
        $command.Parameters.AddWithValue("@VMHostModel", $VMHostModel)
        $command.Parameters.AddWithValue("@eventDate", $eventDate)
        $command.Parameters.AddWithValue("@eventMessage", $eventMessage)

        $row = $command.ExecuteNonQuery()
    }

    Disconnect-VIServer -Server $vcenter -Confirm:$false
}

$command.Dispose()
$conn.Close()
$conn.Dispose()

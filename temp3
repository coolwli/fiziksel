$apiKey = "8G7kTdsDJLqEVLuGFGHgBC2BxFx4AsQpkKMVQvxrrKd2R0Fc83GNJQQJ99BDACfhMk5XJ3w3AAABACOGVRgB" # Azure OpenAI API anahtarınızı buraya ekleyin
$endpoint = "https://openai-swe-bulutaltyapi.openai.azure.com/openai/deployments/gpt-4.1-bulutaltyapi/chat/completions?api-version=2025-01-01-preview" # Endpoint URL'nizi buraya ekleyin

# Input/Output Configuration
$csvFilePath = "C:\Users\AliCanda\Documents\calismalar\reclaim_api_test.csv"
$csvOutputPath = "C:\Users\AliCanda\Documents\calismalar\reclaim_api_output.csv"

$batchSize = 50

# Read CSV data
$data = Import-Csv -Path $csvFilePath
Write-Host "Found $($data.Count) records to process" -ForegroundColor Green


$columns=$data[0].psobject.Properties.Name[0..8]
# Initialize results array
$allResults = @()
 
 
for ($i = 0; $i -lt $data.Count; $i += $batchSize) {
    $endIndex = if (($i + $batchSize - 1) -lt $data.Count) { $i + $batchSize - 1 } else { $data.Count - 1 }
    $batch = $data[$i..$endIndex]
    
    $selectedBatch = $batch | Select-Object $columns
    $batchJson = $selectedBatch | ConvertTo-Json -Depth 10

    
    # Prompt'u oluştur
    $prompt = @"
        You are a VMware expert. Your task is to analyze CPU and memory usage metrics of virtual machines (VMs) and suggest optimizations.

        ---

        **Input Format (JSON):**  
        Each VM has the following fields:

        - `VM_Name`: string – The hostname of the virtual machine  
        - `Current_CPU`: number – The number of currently allocated vCPUs  
        - `CPU_Usage`: object – Historical CPU usage statistics over the past 3 months:
        - `avg`: average CPU usage (%)  
        - `p95`: 95th percentile CPU usage (%)  
        - `p99`: 99th percentile CPU usage (%)  

        - `Current_Memory`: number – The amount of currently allocated memory (in GB)  
        - `Memory_Usage`: object – Historical memory usage statistics over the past 3 months:
        - `avg`: average memory usage (GB)  
        - `p95`: 95th percentile memory usage (GB)  
        - `p99`: 99th percentile memory usage (GB) 

        Data is provided as:  
        json
        $batchJson
        

        ---
        **What You Need to Do:**

        1. **Reclaim Score Calculation (0–100)**
        - Give a `Reclaim_Score_CPU` and `Reclaim_Score_Memory` for each VM
        - High score = overprovisioned (i.e., resource waste)
        - Be realistic; Develop a professional formula with these metrics and calculate a corresponding score.

        2. **Suggest Optimized Resources:**
        - **CPU:**
            - If score is high, suggest a lower but realistic `Suggested_CPU`
            - Minimum: 2 vCPU (always even)
            - Must not be less than 50% of `Current_CPU`

        - **Memory:**
            - If score is high, suggest a reduced `Suggested_Memory` (GB)
            - Minimum: 4 GB (always even)
            - Must not be less than 50% of `Current_Memory`

        ⚠️ Be cautious — avoid aggressive downsizing that could hurt performance

        ---

        **Output Format (JSON array):**  
        Convert the table results into JSON format without anything!
        Each VM's output should include: VM Name, Current CPU, Reclaim Score CPU, Suggested CPU, Current Memory, Reclaim Score Memory, Suggested Memory
        
"@
    
    # JSON body oluştur
    $body = @{
        messages = @(
            @{
                role = "system"
                content =   "You are a cloud‑resources optimization assistant. " +
                            "Your job is to analyze VM CPU & memory usage metrics, " +
                            "compute a light‑touch reclaim score, and recommend new vCPU+RAM pairs. " +
                            "Be precise, concise, and follow the rules strictly."
            },
            @{
                role = "user"
                content = $prompt
            }
        )
        temperature = 0.7
    } | ConvertTo-Json -Depth 10

    # HTTP başlıkları
    $headers = @{
        "Content-Type" = "application/json"
        "api-key" = $apiKey
    }

    # API'ye gönder
    try {
        $response = Invoke-RestMethod -Uri $endpoint -Method Post -Headers $headers -Body $body
        $answer = $response.choices[0].message.content
        if ($answer -like '*`*') {
            $answer = $answer -replace '[`]', ''
        }

        # çıktıya diğer sütunları ekle
        $batchHash = @{}
        foreach ($row in $batch) {
            $batchHash[$row.'Name'] = $row
        }
        $answerjson = $answer | ConvertFrom-Json
        foreach ($apiResult in $answerjson) {
            $vmName = $apiResult.'VM Name'
            $original = $batchHash[$vmName]

            # Ek sütunları ekle(web sayfası için)
            $apiResult | Add-Member -NotePropertyName "Summary|Parent vCenter" -NotePropertyValue $original.'Summary|Parent vCenter'
            $apiResult | Add-Member -NotePropertyName "Summary|UUID" -NotePropertyValue $original.'Summary|UUID'

            $allResults += $apiResult
        }
        Write-Host "Batch $($i / $batchSize + 1) işlendi." 
    } catch {
        Write-Host "Hata oluştu: $($_.Exception.Message)"
    }
}

# Sonuçları tek bir CSV dosyasında birleştir
$mergedResults = @()
foreach ($result in $allResults) {
    $obj = New-Object PSObject
    $obj | Add-Member -NotePropertyName "VM Name" -NotePropertyValue $result.'VM Name'
    $obj | Add-Member -NotePropertyName "Current CPU" -NotePropertyValue $result.'Current CPU'
    $obj | Add-Member -NotePropertyName "Reclaim Score CPU" -NotePropertyValue $result.'Reclaim Score CPU'
    $obj | Add-Member -NotePropertyName "Suggested CPU" -NotePropertyValue $result.'Suggested CPU'
    $obj | Add-Member -NotePropertyName "Current Memory" -NotePropertyValue $result.'Current Memory'
    $obj | Add-Member -NotePropertyName "Reclaim Score Memory" -NotePropertyValue $result.'Reclaim Score Memory'
    $obj | Add-Member -NotePropertyName "Suggested Memory" -NotePropertyValue $result.'Suggested Memory'
    $obj | Add-Member -NotePropertyName "Summary|Parent vCenter" -NotePropertyValue $result.'Summary|Parent vCenter'
    $obj | Add-Member -NotePropertyName "Summary|UUID" -NotePropertyValue $result.'Summary|UUID'
    $mergedResults += $obj
}


# İlk satırı (başlık) atla ve CSV'ye yaz
$mergedResults | Export-Csv -Path $csvOutputPath -NoTypeInformation -Encoding UTF8
Write-Host "Sonuçlar $csvOutputPath dosyasına kaydedildi."
